"use strict";angular.module("gpConnect",["ngResource","ngTouch","ngAnimate","ui.router","ui.bootstrap","angular-loading-bar","growlNotifications","angularUtils.directives.dirPagination","ui.timepicker","ui.calendar","angularSpinner"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("patients-list",{url:"/patients?ageRange&department&order&reverse",views:{main:{templateUrl:"views/patients/patients-list.html",controller:"PatientsListCtrl"}},params:{patientsList:[],advancedSearchParams:[],displayEmptyTable:!1}}).state("main-search",{url:"/search",views:{main:{templateUrl:"views/search/main-search.html",controller:"MainSearchController"}}}).state("patients-summary",{url:"/patients/{patientId:int}/patients-summary",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/patients/patients-summary.html",controller:"PatientsSummaryCtrl"}}}).state("problem-list",{url:"/patients/{patientId:int}/problem",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/problem/problem-list.html",controller:"ProblemListCtrl"}}}).state("problem-detail",{url:"/patients/{patientId:int}/problem/{problemIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/problem/problem-list.html",controller:"ProblemListCtrl"},detail:{templateUrl:"views/problem/problem-detail.html",controller:"ProblemDetailCtrl"}}}).state("allergies",{url:"/patients/{patientId:int}/allergies",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/allergies/allergies-list.html",controller:"AllergiesListCtrl"}}}).state("allergies-detail",{url:"/patients/{patientId:int}/allergies/{allergyIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/allergies/allergies-list.html",controller:"AllergiesListCtrl"},detail:{templateUrl:"views/allergies/allergies-detail.html",controller:"AllergiesDetailCtrl"}}}).state("medications",{url:"/patients/{patientId:int}/medications",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/medications/medications-list.html",controller:"MedicationsListCtrl"}}}).state("medications-detail",{url:"/patients/{patientId:int}/medications/{medicationIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/medications/medications-list.html",controller:"MedicationsListCtrl"},detail:{templateUrl:"views/medications/medications-detail.html",controller:"MedicationsDetailCtrl"}}}).state("procedures",{url:"/patients/{patientId:int}/procedures",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/procedures/procedures-list.html",controller:"ProceduresListCtrl"}}}).state("procedures-detail",{url:"/patients/{patientId:int}/procedures/{procedureId}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/procedures/procedures-list.html",controller:"ProceduresListCtrl"},detail:{templateUrl:"views/procedures/procedures-detail.html",controller:"ProceduresDetailCtrl"}}}).state("referrals",{url:"/patients/{patientId:int}/referrals",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/referrals/referrals-list.html",controller:"ReferralsListCtrl"}}}).state("referrals-detail",{url:"/patients/{patientId:int}/referrals/{referralId}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/referrals/referrals-list.html",controller:"ReferralsListCtrl"},detail:{templateUrl:"views/referrals/referrals-detail.html",controller:"ReferralsDetailCtrl"}}}).state("results",{url:"/patients/{patientId:int}/results",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/results/results-list.html",controller:"ResultsListCtrl"}}}).state("results-detail",{url:"/patients/{patientId:int}/results/{resultIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/results/results-list.html",controller:"ResultsListCtrl"},detail:{templateUrl:"views/results/results-detail.html",controller:"ResultsDetailCtrl"}}})}]).directive("datepickerPopup",function(){return{restrict:"EAC",require:"ngModel",link:function(a,b,c,d){d.$formatters.unshift()}}}).directive("mySpace",function(){return function(a,b,c){b.bind("keydown keypress",function(b){32===b.which&&(a.$apply(function(){a.$eval(c.myEnter)}),b.preventDefault())})}}).directive("autoFocus",["$timeout",function(a){return{restrict:"A",require:"ngModel",scope:{ngModel:"="},link:function(b,c,d,e){b.$watch("ngModel",function(b){a(function(){c[0].focus()})})}}}]).directive("isValidNhsNumber",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){a.$watch(c.ngModel,function(a){e(a)}),d.$parsers.unshift(function(a){return e(a)});var e=function(a){if(a){var b=a.replace(/\s+/g,""),c=!isNaN(b)&&10===b.length;return d.$setValidity("invalidNHSNumFormat",c),c?b:""}}}}}).filter("formatNHSNumber",function(){return function(a){return void 0!==a?a.slice(0,3)+" "+a.slice(3,6)+" "+a.slice(6):void 0}}).constant("keyCodes",{esc:27,enter:13}).directive("keyBind",["keyCodes",function(a){function b(b){var c={};for(var d in b){var e=b[d];a.hasOwnProperty(d)&&(c[a[d]]=e)}return c}return function(a,c,d){var e=b(a.$eval(d.keyBind));c.bind("keydown keypress",function(b){e.hasOwnProperty(b.which)&&a.$apply(function(){a.$eval(e[b.which])})})}}]).directive("focusElement",["$timeout",function(a){return{link:function(b,c,d){b.$watch(d.focusElement,function(b){a(function(){b===!0&&c.focus()})})}}}]).directive("rpOnLoad",["$parse",function(a){return function(b,c,d){var e=a(d.rpOnLoad);c.on("load",function(a){b.$apply(function(){e(b,{$event:a})})})}}]).config(["datepickerConfig","datepickerPopupConfig","cfpLoadingBarProvider",function(a,b,c){a.startingDay=1,b.showButtonBar=!1,b.datepickerPopup="dd-MMM-yyyy",c.includeSpinner=!1}]).config(["paginationTemplateProvider",function(a){a.setPath("views/dirPagination.tpl.html")}]),angular.module("gpConnect").value("claims",{sub:"28AD8576-1948-4C84-8B5E-55FB7EE027CE",given_name:"Bob",family_name:"Smith",email:"gpconnect@example.com",date_of_birth:"19/04/2016",scope:{setting1:!0,setting2:!0},tenant_id:"HSCIC",tenant_name:"GP Connect",role:"gpconnect"}),angular.module("gpConnect").value("content",{gpconnect_title:"GPConnect Demonstrator"}),angular.module("gpConnect").factory("UserService",["$location","$http","claims","content",function(a,b,c,d){var e={role:c.role,email:c.email,tenant:{id:c.tenant_id,name:c.tenant_name},firstName:c.given_name,surname:c.family_name,dateOfBirth:c.date_of_birth,isAuthenticated:!0,feature:c.scope},f=function(){var b=a.search();e.email=b.email||e.email,e.role=b.role||e.role},g=function(){return e},h=function(a){return d[a]};return{setCurrentUserFromQueryString:f,getCurrentUser:g,getContent:h}}]),angular.module("gpConnect").factory("PatientService",["$http","Patient",function(a,b){var c=function(){return a.get("/api/patients").then(function(a){var c=[];return angular.forEach(a.data,function(a){a=new b(a),c.push(a)}),c})},d=function(c){return a.get("/api/patients/"+c,{cache:!0}).then(function(a){return new b(a.data)})},e=function(b){var c={address1:b.address1,address2:b.address2,address3:b.address3,address4:b.address4,address5:b.address5,born:b.born,department:b.department,firstname:b.firstname,gPPractice:b.gPPractice,gender:b.gender,id:b.id,lastname:b.lastname,nhsNo:b.nhsNo,phone:b.phone,postCode:b.postCode,title:b.title};return a.put("/api/patients",c)},f=function(a,b){var c=_.findWhere(a.problem,{id:b.id});angular.extend(c,b)},g=function(a,b,c){var d=a[b];a[b]=a[c],a[c]=d},h=function(){return c().then(function(a){var b={};return b.age=_.chain(a).filter(function(a){return!!a.age}).countBy(function(a){return a.ageRange}).map(function(a,b){return{series:b,value:a}}).reverse().value(),g(b.age,3,4),b.department=_.chain(a).filter(function(a){return!!a.department}).countBy(function(a){return a.department}).map(function(a,b){return{series:b,value:a}}).sortBy(function(a){return a.department}).value(),b})};return{all:c,get:d,update:f,summaries:h,create:e}}]),angular.module("gpConnect").factory("Helper",function(){var a=function(a){var b=a.split("::"),c=parseInt(b[2])+1,d=b[0]+"::"+b[1]+"::"+c;return d};return{updateId:a}}),angular.module("gpConnect").factory("Problem",["$http",function(a){var b=function(b){return a.get("/api/patients/"+b+"/problem")},c=function(b,c,d){return a.get("/api/patients/"+b+"/problem/"+c+"?source="+d)},d=function(b,c){return a.get("/api/patients/"+b+"/problem/htmlTables?source="+c)},e=function(b,c){return a.post("/api/patients/"+b+"/problem",c)},f=function(b,c){return a.put("/api/patients/"+b+"/problem",c)};return{findAllSummaries:b,findDetails:c,findAllHTMLTables:d,update:f,create:e}}]),angular.module("gpConnect").factory("Allergy",["$http",function(a){var b=function(b){return a.get("/api/patients/"+b+"/allergies")},c=function(b,c,d){return a.get("/api/patients/"+b+"/allergies/"+c+"?source="+d)},d=function(b,c){return a.get("/api/patients/"+b+"/allergies/htmlTables?source="+c)},e=function(b,c){return a.post("/api/patients/"+b+"/allergies",c)},f=function(b,c){return a.put("/api/patients/"+b+"/allergies",c)};return{findAllSummaries:b,findDetails:c,findAllHTMLTables:d,createAllergy:e,updateAllergy:f}}]),angular.module("gpConnect").factory("Medication",["$http",function(a){var b=function(b){return a.get("/api/patients/"+b+"/medications")},c=function(b,c,d){return a.get("/api/patients/"+b+"/medications/"+c+"?source="+d)},d=function(b,c){return a.get("/api/patients/"+b+"/medications/htmlTables?source="+c)},e=function(b,c){return a.post("/api/patients/"+b+"/medications",c)},f=function(b,c){return a.put("/api/patients/"+b+"/medications",c)};return{findAllMedications:b,findMedication:c,findAllHTMLTables:d,createMedication:e,updateMedication:f}}]),angular.module("gpConnect").factory("SmspLookup",["$http","Patient",function(a,b){var c=function(c,d){return a.post("/api/smsp-search",{firstname:c,lastname:d}).then(function(a){var c=[];return angular.forEach(a.data,function(a){a=new b(a),c.push(a)}),c})};return{byName:c}}]),angular.module("gpConnect").factory("Appointment",["$http",function(a){var b=function(b){return a.get("/api/patients/"+b+"/appointments")},c=function(b,c){return a.get("/api/patients/"+b+"/appointments/"+c)},d=function(b,c){return console.log("post appointment comp:"),console.log(c),a.post("/api/patients/"+b+"/appointments",c)},e=function(b,c){return console.log("put appointment comp:"),console.log(c),a.put("/api/patients/"+b+"/appointments",c)};return{all:b,get:c,update:e,create:d}}]),angular.module("gpConnect").factory("Referral",["$http",function(a){var b=function(b){return a.get("/api/patients/"+b+"/referrals")},c=function(b,c){return a.get("/api/patients/"+b+"/referrals/"+c)},d=function(b,c){return a.get("/api/patients/"+b+"/referrals/htmlTables?source="+c)},e=function(b,c){return a.post("/api/patients/"+b+"/referrals",c)},f=function(b,c){return a.put("/api/patients/"+b+"/referrals",c)};return{findAllSummaries:b,findDetails:c,findAllHTMLTables:d,update:f,create:e}}]),angular.module("gpConnect").factory("Procedure",["$http",function(a){var b=function(b){return a.get("/api/patients/"+b+"/procedures")},c=function(b,c,d){return a.get("/api/patients/"+b+"/procedures/"+c+"?source="+d)},d=function(b,c){return a.post("/api/patients/"+b+"/procedures",c)},e=function(b,c){return a.put("/api/patients/"+b+"/procedures",c)};return{all:b,get:c,update:e,create:d}}]),angular.module("gpConnect").factory("DateFormatter",function(){var a=function(a){return moment(a).format("YYYY-MM-DD")};return{clean:a}}),angular.module("gpConnect").factory("Result",["$http",function(a){var b=function(b,c,d){return a.get("/api/patients/"+b+"/labresults/"+c+"?source="+d)},c=function(b){return a.get("/api/patients/"+b+"/labresults")};return{all:c,get:b}}]),angular.module("gpConnect").factory("Report",["$http",function(a){var b=function(b){return a.post("/api/search/reports/table",b)},c=function(b){return a.post("/api/search/setting/table",b)},d=function(b){return a.post("/api/search/reports/chart",b)},e=function(b){return a.post("/api/search/patient/table",b)};return{getChart:d,getTable:b,getSettingsTable:c,searchByPatient:e}}]),angular.module("gpConnect").factory("AdvancedSearch",["$modal","$http",function(a,b){var c=!0,d=function(b){if(c){c=!1;var d=a.open({templateUrl:"views/search/advanced-search-modal.html",size:"lg",controller:"AdvancedSearchController",resolve:{modal:function(){return{title:"Advanced Search"}},searchParams:function(){var a={};return isNaN(b)?a.surname=b:a.nhsNumber=b,a}}})}d.result.then(function(){c=!0},function(){c=!0})},e=function(a){return b.post("/api/patients/advancedSearch",a)};return{isModalClosed:c,openAdvancedSearch:d,searchByDetails:e}}]),angular.module("gpConnect").factory("Patient",["$window",function(a){var b=function(b){var c=this;_.extend(this,b),c.age=function(){return a.moment().diff(c.dateOfBirth,"years")},c.ageRange=function(){var a=c.age();switch(!0){case a>=0&&10>=a:return"0-10";case a>=11&&18>=a:return"11-18";case a>=19&&30>=a:return"19-30";case a>=31&&60>=a:return"31-60";case a>=60&&80>=a:return"60-80";case a>80:return">80";default:return}}()};return b}]),angular.module("gpConnect").controller("PatientsListCtrl",["$scope","$state","$stateParams","$location","$modal","PatientService",function(a,b,c,d,e,f){0!=c.patientsList.length||c.displayEmptyTable?(a.patients=c.patientsList,d.url(d.path()),a.filters={advancedSearch:!0,advancedSearchParams:c.advancedSearchParams}):(f.all().then(function(b){a.patients=b}),a.order=c.order||"name",a.reverse="true"===c.reverse,a.filters={department:c.department,ageRange:c.ageRange}),a.sort=function(d){var e=a.reverse;a.order===d&&(e=!e),b.transitionTo(b.current,_.extend(c,{order:d,reverse:e}))},a.sortClass=function(b){return a.order===b?a.reverse?"sort-desc":"sort-asc":void 0},a.go=function(c){b.go("patients-summary",{patientId:c.id,patientsList:a.patients})},a.patientFilter=function(b){return a.filters.department?b.department===a.filters.department:a.filters.ageRange?b.ageRange===a.filters.ageRange:!0},a.openAdvancedSearch=function(){e.open({templateUrl:"views/search/advanced-search-modal.html",size:"lg",controller:"AdvancedSearchController",resolve:{modal:function(){return{title:"Advanced Search"}},searchParams:function(){return c.advancedSearchParams}}})}}]),angular.module("gpConnect").controller("headerController",["$scope","$rootScope","$state","usSpinnerService","$stateParams","UserService",function(a,b,c,d,e,f){switch(f.setCurrentUserFromQueryString(),a.currentUser=f.getCurrentUser(),a.currentUser.role){case"gpconnect":c.go("main-search");break;case"phr":c.go("patients-summary",{patientId:9999999e3});break;default:c.go("patients-summary",{patientId:9999999e3})}b.$on("$stateChangeSuccess",function(b,d){var e="",g="",h="",i=0,j=0;switch(d.name){case"main-search":e="",g="Welcome",h="",i=12,j=0;break;case"patients-list":e="main-search",g="Patient Lists",h="Patient Dashboard",i=12,j=0;break;case"patients-summary":e="patients-list",g="Patient Summary",h="Patient Lists",i=12,j=0;break;case"patients-lookup":e="",g="Patients lookup",h="",i=6,j=6;break;default:e="patients-list",g="Patients Details",h="Patient Lists",i=6,j=6}a.pageHeader=g,a.previousState=e,a.previousPage=h,a.mainWidth=i,a.detailWidth=j,a.goBack=function(){history.back()},a.userContextViewExists="user-context"in c.current.views,a.actionsExists="actions"in c.current.views,a.go=function(a){c.go("patients-summary",{patientId:a.id})},"gpconnect"===a.currentUser.role&&(a.title=f.getContent("gpconnect_title")),"phr"===a.currentUser.role&&(a.title=f.getContent("phr_title")),a.footer=f.getContent("gpconnect_footer"),a.goHome=function(){"gpconnect"===a.currentUser.role&&c.go("main-search"),"phr"===a.currentUser.role&&c.go("patients-summary",{patientId:9999999e3})}})}]),angular.module("gpConnect").controller("PatientsLookupCtrl",["$modal","$state",function(a,b){a.open({templateUrl:"views/patients/patients-lookup.html",size:"lg",controller:["$scope","SmspLookup","PatientService",function(a,b,c){a.search=function(c,d){a.searching=!0,b.byName(c,d).then(function(b){a.patients=b,a.searching=!1},function(){a.searching=!1})},a.create=function(b){c.create(b).then(function(){a.save()})},a.dismiss=function(){a.$dismiss()},a.save=function(){a.$close(!0)}}]}).result["finally"](function(){b.go("patients-charts")})}]),angular.module("gpConnect").controller("PatientsSummaryCtrl",["$scope","$stateParams","$state","$rootScope","$location","usSpinnerService","PatientService",function(a,b,c,d,e,f,g){a.patients=b.patientsList,g.get(b.patientId).then(function(b){a.patient=b,f.stop("patientSummary-spinner")}),a.go=function(a){e.path(a)},a.goToSection=function(a){({patientId:b.patientId})}}]),angular.module("gpConnect").controller("PatientsDetailCtrl",["$scope","$stateParams","$state","PatientService",function(a,b,c,d){d.get(b.patientId).then(function(b){a.patient=b}),a.goTo=function(a){var d={patientId:b.patientId},e="";switch(a){case"summary":e="patients-summary";break;case"problem":e="problem-list";break;case"allergies":e="allergies";break;case"medications":e="medications";break;case"results":e="results";break;case"procedures":e="procedures";break;case"referrals":e="referrals";break;case"appointments":e="appointments";break;case"careplans":e="eolcareplans";break;case"mdt":e="cancerMdt"}c.go(e,d)}}]),angular.module("gpConnect").controller("ProblemListCtrl",["$scope","$state","$stateParams","$location","$sce","$modal","usSpinnerService","PatientService","Problem",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.search=function(b){return-1!==angular.lowercase(b.problem).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.dateOfOnset).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.source).indexOf(angular.lowercase(a.query)||"")},c.filter&&(a.query=c.filter),h.get(c.patientId).then(function(b){a.patient=b}),i.findAllHTMLTables(c.patientId).then(function(b){a.problemTables=b.data;for(var c=0;c<a.problemTables.length;c++)a.problemTables[c].html=e.trustAsHtml(a.problemTables[c].html);g.stop("problemSummary-spinner")}),a.go=function(d,e){b.go("problem-detail",{patientId:a.patient.id,problemIndex:d,filter:a.query,page:a.currentPage,reportType:c.reportType,searchString:c.searchString,queryType:c.queryType,source:e})},a.selected=function(a){return a===c.problemIndex},a.create=function(){var c=f.open({templateUrl:"views/problem/problem-modal.html",size:"lg",controller:"ProblemModalCtrl",resolve:{modal:function(){return{title:"Create Problem"}},problem:function(){return{}},patient:function(){return a.patient}}});c.result.then(function(c){c.dateOfOnset=new Date(c.dateOfOnset);var d={code:c.code,dateOfOnset:c.dateOfOnset,description:c.description,problem:c.problem,source:c.source,sourceId:"",terminology:c.terminology};i.create(a.patient.id,d).then(function(){setTimeout(function(){b.go("problem-list",{patientId:a.patient.id,filter:a.query,page:a.currentPage},{reload:!0})},2e3)})})}}]),angular.module("gpConnect").controller("ProblemDetailCtrl",["$scope","$stateParams","$location","$modal","Helper","$state","usSpinnerService","PatientService","Problem",function(a,b,c,d,e,f,g,h,i){a.UnlockedSources=["handi.ehrscape.com"],h.get(b.patientId).then(function(b){a.patient=b}),i.get(b.patientId,b.problemIndex,b.source).then(function(b){a.problem=b.data,g.stop("problemDetail-spinner")}),a.formDisabled=!0,a.edit=function(){var b=d.open({templateUrl:"views/problem/problem-modal.html",size:"lg",controller:"ProblemModalCtrl",resolve:{modal:function(){return{title:"Edit Problem"}},problem:function(){return angular.copy(a.problem)},patient:function(){return a.patient}}});b.result.then(function(b){var c={code:b.code,dateOfOnset:b.dateOfOnset,description:b.description,problem:b.problem,source:b.source,sourceId:b.sourceId,terminology:b.terminology};i.update(a.patient.id,c).then(function(){setTimeout(function(){f.go("problem-detail",{patientId:a.patient.id,problemIndex:"openehr"===b.source?e.updateId(b.sourceId):b.sourceId,page:a.currentPage})},2e3)})})},a.isLocked=function(b){if(!b||!b.id)return!0;var c=b.id.toString().split("::");return c.length>1?a.UnlockedSources.indexOf(c[1])<0:!0},a.convertToLabel=function(a){var b=a.replace(/([A-Z])/g," $1");return b.charAt(0).toUpperCase()+b.slice(1)}}]),angular.module("gpConnect").controller("ProblemModalCtrl",["$scope","$modalInstance","UserService","problem","patient","modal",function(a,b,c,d,e,f){a.currentUser=c.getCurrentUser(),a.problem=d,a.patient=e,a.modal=f,a.protocol="http://","Edit Problem"===f.title?(a.problem.dateSubmitted=(new Date).toISOString().slice(0,10),a.problem.dateOfOnset=new Date(a.problem.dateOfOnset).toISOString().slice(0,10)):(a.problem.dateSubmitted=(new Date).toISOString().slice(0,10),a.problem.code="12393890"),a.changeProtocol=function(b){switch(b){case"http":a.protocol="http://";break;case"https":a.protocol="https://";break;default:a.protocol="http://"}},a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0}}]),angular.module("gpConnect").controller("AllergiesListCtrl",["$scope","$location","$stateParams","$sce","$modal","$state","usSpinnerService","PatientService","Allergy",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.search=function(b){return-1!==angular.lowercase(b.cause).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.reaction).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.source).indexOf(angular.lowercase(a.query)||"")},c.filter&&(a.query=c.filter),h.get(c.patientId).then(function(b){a.patient=b}),i.findAllHTMLTables(c.patientId).then(function(b){a.allergyTables=b.data;for(var c=0;c<a.allergyTables.length;c++)a.allergyTables[c].html=d.trustAsHtml(a.allergyTables[c].html);g.stop("allergySummary-spinner")}),a.go=function(b,c){f.go("allergies-detail",{patientId:a.patient.id,allergyIndex:b,filter:a.query,page:a.currentPage,source:c})},a.selected=function(a){return a===c.allergyIndex},a.create=function(){var b=e.open({templateUrl:"views/allergies/allergies-modal.html",size:"lg",controller:"AllergiesModalCtrl",resolve:{modal:function(){return{title:"Create Allergy"}},allergy:function(){return{}},patient:function(){return a.patient}}});b.result.then(function(b){var c={sourceId:"",cause:b.cause,causeCode:b.causeCode,causeTerminology:b.causeTerminology,reaction:b.reaction,source:b.source};i.create(a.patient.id,c).then(function(){setTimeout(function(){f.go("allergies",{patientId:a.patient.id,filter:a.query,page:a.currentPage},{reload:!0})},2e3)})})}}]),angular.module("gpConnect").controller("AllergiesDetailCtrl",["$scope","$stateParams","$modal","$state","$location","Helper","usSpinnerService","PatientService","Allergy",function(a,b,c,d,e,f,g,h,i){h.get(b.patientId).then(function(b){a.patient=b}),i.get(b.patientId,b.allergyIndex,b.source).then(function(b){a.allergy=b.data,g.stop("allergiesDetail-spinner")}),a.edit=function(){var b=c.open({templateUrl:"views/allergies/allergies-modal.html",size:"lg",controller:"AllergiesModalCtrl",resolve:{modal:function(){return{title:"Edit Allergy"}},allergy:function(){return angular.copy(a.allergy)},patient:function(){return a.patient}}});b.result.then(function(b){var c={sourceId:b.sourceId,cause:b.cause,causeCode:b.causeCode,causeTerminology:b.causeTerminology,reaction:b.reaction,source:b.source};i.update(a.patient.id,c).then(function(){setTimeout(function(){d.go("allergies-detail",{patientId:a.patient.id,allergyIndex:"openehr"===b.source?f.updateId(b.sourceId):b.sourceId,page:a.currentPage})},2e3)})})}}]),angular.module("gpConnect").controller("AllergiesModalCtrl",["$scope","$modalInstance","allergy","UserService","patient","modal",function(a,b,c,d,e,f){a.currentUser=d.getCurrentUser(),a.allergy=c,a.patient=e,a.modal=f,"Create Allergy"===f.title?(a.allergy.dateCreated=(new Date).toISOString().slice(0,10),a.allergy.causeCode="1239085",a.allergy.terminologyCode="12393890"):a.allergy.dateCreated=new Date(a.allergy.dateCreated).toISOString().slice(0,10),a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0}}]),angular.module("gpConnect").controller("MedicationsListCtrl",["$scope","$location","$stateParams","$modal","$state","$sce","usSpinnerService","PatientService","Medication",function(a,b,c,d,e,f,g,h,i){a.query={},a.queryBy="$",a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),h.get(c.patientId).then(function(b){a.patient=b}),c.filter&&(a.query.$=c.filter),i.findAllHTMLTables(c.patientId).then(function(b){a.medicationTables=b.data;for(var c=0;c<a.medicationTables.length;c++)a.medicationTables[c].html=f.trustAsHtml(a.medicationTables[c].html);g.stop("medicationSummary-spinner")}),a.go=function(b,c){e.go("medications-detail",{patientId:a.patient.id,medicationIndex:b,filter:a.query.$,page:a.currentPage,source:c})},a.selected=function(a){return a===c.medicationIndex},a.create=function(){var b=d.open({templateUrl:"views/medications/medications-modal.html",size:"lg",controller:"MedicationsModalCtrl",resolve:{modal:function(){return{title:"Create Medication"}},medication:function(){return{}},patient:function(){return a.patient}}});b.result.then(function(b){b.startDate=new Date(b.startDate),b.startTime=new Date(b.startTime.valueOf()-6e4*b.startTime.getTimezoneOffset());var c={sourceId:"",doseAmount:b.doseAmount,doseDirections:b.doseDirections,doseTiming:b.doseTiming,medicationCode:b.medicationCode,medicationTerminology:b.medicationTerminology,name:b.name,route:b.route,startDate:b.startDate,startTime:b.startTime,author:b.author,dateCreated:b.dateCreated};i.create(a.patient.id,c).then(function(){setTimeout(function(){e.go("medications",{patientId:a.patient.id,filter:a.query.$,page:a.currentPage},{reload:!0})},2e3)})})}}]),angular.module("gpConnect").controller("MedicationsDetailCtrl",["$scope","$stateParams","$modal","$location","$state","Helper","usSpinnerService","PatientService","Medication",function(a,b,c,d,e,f,g,h,i){h.get(b.patientId).then(function(b){a.patient=b}),i.get(b.patientId,b.medicationIndex,b.source).then(function(b){a.medication=b.data,g.stop("medicationsDetail-spinner")}),a.edit=function(){var b=c.open({templateUrl:"views/medications/medications-modal.html",size:"lg",controller:"MedicationsModalCtrl",resolve:{modal:function(){return{title:"Edit Medication"}},medication:function(){return angular.copy(a.medication)},patient:function(){return a.patient}}});b.result.then(function(b){b.startDate=new Date(b.startDate);var c={sourceId:b.sourceId,doseAmount:b.doseAmount,route:b.route,doseDirections:b.doseDirections,doseTiming:b.doseTiming,medicationCode:b.medicationCode,medicationTerminology:b.medicationTerminology,name:b.name,startDate:b.startDate,startTime:b.startTime,source:b.source};i.update(a.patient.id,c).then(function(){setTimeout(function(){e.go("medications-detail",{patientId:a.patient.id,medicationIndex:"Marand"===b.source?b.updateId(b.sourceId):b.sourceId,page:a.currentPage})},2e3)})})}}]),angular.module("gpConnect").controller("MedicationsModalCtrl",["$scope","$modalInstance","UserService","medication","patient","modal",function(a,b,c,d,e,f){a.currentUser=c.getCurrentUser(),a.medication=d,a.patient=e,a.modal=f,a.routes=["Po Per Oral","IV Intra Venous","PN Per Nasal","PR Per Rectum","SL Sub Lingual","SC Sub Cutaneous","IM Intra Muscular"],"Edit Medication"===f.title?(a.medication.startTime=new Date(a.medication.startTime),a.medication.startDate=new Date(a.medication.startDate).toISOString().slice(0,10),a.medication.dateCreated=new Date(a.medication.dateCreated).toISOString().slice(0,10)):(a.medication.medicationCode=void 0==a.medication.medicationCode?"123456789":a.medication.medicationCode,a.medication.dateCreated=(new Date).toISOString().slice(0,10)),a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0}}]),angular.module("gpConnect").controller("AppointmentsModalCtrl",["$scope","$modalInstance","$modal","UserService","appointment","patient","modal",function(a,b,c,d,e,f,g){function h(b){var d=c.open({templateUrl:"views/appointments/appointments-confirm-modal.html",size:"sm   ",windowClass:"confirm-modal",controller:"AppointmentsConfirmModalCtrl",resolve:{modal:function(){return{title:"Confirm Date"}},time:function(){return angular.copy(b)}}});d.result.then(function(){a.appointment.timeOfAppointment=b,a.appointment.status="Scheduled",a.appointment.dateOfAppointment=b.toISOString().slice(0,10),a.timeSlotFull=moment(a.appointment.timeOfAppointment).format("h:mma")+"-"+moment(a.appointment.timeOfAppointment).add(59,"m").format("h:mma"),i(),a.radioModel="Tab1"})}function i(){for(var b=a.appointment.dateOfAppointment.slice(0,10)+" "+a.appointment.timeOfAppointment.toISOString().slice(11,13)+":00",c=0;c<a.uiConfig.calendar.events.length;c++){var d=a.uiConfig.calendar.events[c];"#6599C8"===d.color&&(d.color="#378006"),d.start===b&&(d.color="#6599C8")}}a.currentUser=d.getCurrentUser(),a.appointment=e,a.patient=f,a.modal=g,a.radioModel="Tab1",a.appointment.location=e.location||"Leeds General",a.appointment.status=e.status||"Not Scheduled","Edit Appointment"===g.title?(a.appointment.dateCreated=new Date(a.appointment.dateCreated).toISOString(),a.appointment.dateOfAppointment=new Date(a.appointment.dateOfAppointment).toISOString(),a.appointment.timeOfAppointment=new Date(a.appointment.timeOfAppointment)):a.appointment.dateCreated=(new Date).toISOString().slice(0,10),"Scheduled"===a.appointment.status&&(a.timeSlotFull=moment(e.timeOfAppointment).format("h:mma")+"-"+moment(e.timeOfAppointment).add(59,"m").format("h:mma")),
a.uiConfig={calendar:{height:450,width:400,editable:!0,aspectRatio:1.7,defaultDate:"2015-02-12",Duration:"01:00:00",lang:"en-gb",eventColor:"#378006",events:[{title:"Time Slot 1",start:"2015-02-09 09:00",end:"2015-02-09 09:59"},{title:"Time Slot 2",start:"2015-02-09 10:00",end:"2015-02-09 10:59"},{title:"Time Slot 3",start:"2015-02-09 11:00",end:"2015-02-09 11:59"},{title:"Time Slot 4",start:"2015-02-09 12:00",end:"2015-02-09 12:59"},{title:"Time Slot 5",start:"2015-02-09 13:00",end:"2015-02-09 13:59"},{title:"Time Slot 6",start:"2015-02-09 14:00",end:"2015-02-09 14:59"},{title:"Time Slot 7",start:"2015-02-09 15:00",end:"2015-02-09 15:59"},{title:"Time Slot 8",start:"2015-02-09 16:00",end:"2015-02-09 16:59"},{title:"Time Slot 1",start:"2015-02-10 09:00",end:"2015-02-10 09:59"},{title:"Time Slot 2",start:"2015-02-10 10:00",end:"2015-02-10 10:59"},{title:"Time Slot 3",start:"2015-02-10 11:00",end:"2015-02-10 11:59"},{title:"Time Slot 4",start:"2015-02-10 12:00",end:"2015-02-10 12:59"},{title:"Time Slot 5",start:"2015-02-10 13:00",end:"2015-02-10 13:59"},{title:"Time Slot 6",start:"2015-02-10 14:00",end:"2015-02-10 14:59"},{title:"Time Slot 7",start:"2015-02-10 15:00",end:"2015-02-10 15:59"},{title:"Time Slot 8",start:"2015-02-10 16:00",end:"2015-02-10 16:59"},{title:"Time Slot 1",start:"2015-02-11 09:00",end:"2015-02-11 09:59"},{title:"Time Slot 2",start:"2015-02-11 10:00",end:"2015-02-11 10:59"},{title:"Time Slot 3",start:"2015-02-11 11:00",end:"2015-02-11 11:59"},{title:"Time Slot 4",start:"2015-02-11 12:00",end:"2015-02-11 12:59"},{title:"Time Slot 5",start:"2015-02-11 13:00",end:"2015-02-11 13:59"},{title:"Time Slot 6",start:"2015-02-11 14:00",end:"2015-02-11 14:59"},{title:"Time Slot 7",start:"2015-02-11 15:00",end:"2015-02-11 15:59"},{title:"Time Slot 8",start:"2015-02-11 16:00",end:"2015-02-11 16:59"},{title:"Time Slot 1",start:"2015-02-12 09:00",end:"2015-02-12 09:59"},{title:"Time Slot 2",start:"2015-02-12 10:00",end:"2015-02-12 10:59"},{title:"Time Slot 3",start:"2015-02-12 11:00",end:"2015-02-12 11:59"},{title:"Time Slot 4",start:"2015-02-12 12:00",end:"2015-02-12 12:59"},{title:"Time Slot 5",start:"2015-02-12 13:00",end:"2015-02-12 13:59"},{title:"Time Slot 6",start:"2015-02-12 14:00",end:"2015-02-12 14:59"},{title:"Time Slot 7",start:"2015-02-12 15:00",end:"2015-02-12 15:59"},{title:"Time Slot 8",start:"2015-02-12 16:00",end:"2015-02-12 16:59"},{title:"Time Slot 1",start:"2015-02-13 09:00",end:"2015-02-13 09:59"},{title:"Time Slot 2",start:"2015-02-13 10:00",end:"2015-02-13 10:59"},{title:"Time Slot 3",start:"2015-02-13 11:00",end:"2015-02-13 11:59"},{title:"Time Slot 4",start:"2015-02-13 12:00",end:"2015-02-13 12:59"},{title:"Time Slot 5",start:"2015-02-13 13:00",end:"2015-02-13 13:59",color:"#dd2b08"},{title:"Time Slot 6",start:"2015-02-13 14:00",end:"2015-02-13 14:59"},{title:"Time Slot 7",start:"2015-02-13 15:00",end:"2015-02-13 15:59"},{title:"Time Slot 8",start:"2015-02-13 16:00",end:"2015-02-13 16:59"}],header:{right:"month,agendaWeek,agendaDay",center:"title",left:"prev,next"},columnFormat:{week:"ddd D/M"},eventClick:function(b){a.setTimeSlot(b.start)},eventMouseover:function(a){"#dd2b08"===a.color&&$(this).css("cursor","not-allowed")},eventDrop:a.alertOnDrop,eventResize:a.alertOnResize,defaultView:"agendaWeek",allDaySlot:!1,minTime:"9:00",maxTime:"17:00",weekends:!1}},a.eventSources=[],"Create Appointment"===g.title?a.appointment.dateCreated=(new Date).toISOString().slice(0,10):(a.appointment.timeOfAppointment=new Date(a.appointment.timeOfAppointment),i());var j=function(){return a.appointment.dateOfAppointment&&a.appointment.timeOfAppointment};a.getScheduleLabel=function(){return j()?" Re-Schedule":" Schedule"},a.openAppointmentDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.setTimeSlot=function(b){for(var c=0;c<a.uiConfig.calendar.events.length;c++){var d=a.uiConfig.calendar.events[c];d.start===b._i&&"#dd2b08"!==d.color&&h(b)}},a.schedule=function(){a.radioModel="Tab2"},a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0}}]),angular.module("gpConnect").controller("AppointmentsConfirmModalCtrl",["$scope","$modalInstance","time",function(a,b,c){a.modal=b,a.time=new Date(c),a.ok=function(){b.close()},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("gpConnect").controller("AppointmentsListCtrl",["$scope","$location","$stateParams","$modal","$state","PatientService","usSpinnerService","Appointment",function(a,b,c,d,e,f,g,h){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.search=function(b){return-1!==angular.lowercase(b.dateOfAppointment).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.timeOfAppointment).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.serviceTeam).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.source).indexOf(angular.lowercase(a.query)||"")},f.get(c.patientId).then(function(b){a.patient=b}),c.filter&&(a.query=c.filter),h.all(c.patientId).then(function(b){a.appointments=b.data;for(var c=0;c<a.appointments.length;c++)a.appointments[c].dateOfAppointment=moment(a.appointments[c].dateOfAppointment).format("DD-MMM-YYYY"),a.appointments[c].timeOfAppointment=moment(a.appointments[c].timeOfAppointment).format("h:mma")+"-"+moment(a.appointments[c].timeOfAppointment).add(59,"m").format("h:mma");g.stop("patientSummary-spinner")}),a.go=function(b){e.go("appointments-detail",{patientId:a.patient.id,appointmentIndex:b,filter:a.query,page:a.currentPage})},a.selected=function(a){return a===c.appointmentIndex},a.create=function(){var b=d.open({templateUrl:"views/appointments/appointments-modal.html",size:"lg",controller:"AppointmentsModalCtrl",resolve:{modal:function(){return{title:"Create Appointment"}},appointment:function(){return{}},patient:function(){return a.patient}}});b.result.then(function(b){b.dateOfAppointment=new Date(b.dateOfAppointment),b.dateCreated=new Date(b.dateCreated);var c={compositionId:"",serviceTeam:b.serviceTeam,dateOfAppointment:b.dateOfAppointment,location:b.location,status:b.status,author:"example@email.com",dateCreated:b.dateCreated,source:"openehr",timeOfAppointment:b.timeOfAppointment};h.create(a.patient.id,c).then(function(){setTimeout(function(){e.go("appointments",{patientId:a.patient.id,filter:a.query,page:a.currentPage},{reload:!0})},2e3)})})}}]),angular.module("gpConnect").controller("AppointmentsDetailCtrl",["$scope","$stateParams","$modal","Helper","$state","$location","usSpinnerService","PatientService","Appointment",function(a,b,c,d,e,f,g,h,i){h.get(b.patientId).then(function(b){a.patient=b}),i.get(b.patientId,b.appointmentIndex).then(function(b){a.appointment=b.data,a.timeOfAppointment=moment(a.appointment.timeOfAppointment).format("h:mma")+"-"+moment(a.appointment.timeOfAppointment).add(59,"m").format("h:mma"),g.stop("appointmentsDetail-spinner")}),a.edit=function(){var b=c.open({templateUrl:"views/appointments/appointments-modal.html",size:"lg",controller:"AppointmentsModalCtrl",resolve:{modal:function(){return{title:"Edit Appointment"}},appointment:function(){return angular.copy(a.appointment)},patient:function(){return a.patient}}});b.result.then(function(b){b.dateOfAppointment=new Date(b.dateOfAppointment),b.dateCreated=new Date(b.dateCreated);var c={sourceId:b.sourceId,serviceTeam:b.serviceTeam,dateOfAppointment:b.dateOfAppointment,location:b.location,status:b.status,author:"example@email.com",dateCreated:b.dateCreated,source:"openehr",timeOfAppointment:b.timeOfAppointment};i.update(a.patient.id,c).then(function(){setTimeout(function(){e.go("appointments-detail",{patientId:a.patient.id,appointmentIndex:d.updateId(b.sourceId)})},2e3)})})}}]),angular.module("gpConnect").controller("ReferralsModalCtrl",["$scope","$modalInstance","UserService","referral","patient","modal",function(a,b,c,d,e,f){$("#dateofreferral").datepicker({dateFormat:"dd-MMM-y"}),a.currentUser=c.getCurrentUser(),a.referral=d,a.patient=e,a.modal=f,"Create Referral"===f.title?(a.referral.dateCreated=(new Date).toISOString().slice(0,10),a.author=a.currentUser):(a.referral.dateCreated=new Date(a.referral.dateCreated).toISOString().slice(0,10),a.referral.dateOfReferral=new Date(a.referral.dateOfReferral).toISOString().slice(0,10)),a.referralCreatedDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.dateofReferralDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.validate=function(a,b,c){var d=b+c;for(var e in a.$error.required){var f=a.$error.required[e].$name;if(f===d)return!0}},a.validateDirty=function(a,b,c){var d=b+c;return a[d].$dirty&&a[d].$invalid},a.validateClean=function(a,b,c){var d=b+c;return a[d].$dirty&&a[d].$valid}}]),angular.module("gpConnect").controller("ReferralsListCtrl",["$scope","$location","$stateParams","$sce","$modal","$state","usSpinnerService","PatientService","Referral",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.search=function(b){return-1!==angular.lowercase(b.dateOfReferral).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.referralFrom).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.referralTo).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.source).indexOf(angular.lowercase(a.query)||"")},h.get(c.patientId).then(function(b){a.patient=b}),c.filter&&(a.query=c.filter),i.findAllHTMLTables(c.patientId).then(function(b){a.referralTables=b.data;for(var c=0;c<a.referralTables.length;c++)a.referralTables[c].html=d.trustAsHtml(a.referralTables[c].html);g.stop("patientSummary-spinner")}),a.go=function(b){f.go("referrals-detail",{patientId:a.patient.id,referralId:b,filter:a.query,page:a.currentPage})},a.selected=function(a){return a===c.referralId},a.create=function(){var b=e.open({templateUrl:"views/referrals/referrals-modal.html",size:"lg",controller:"ReferralsModalCtrl",resolve:{modal:function(){return{title:"Create Referral"}},referral:function(){return{}},patient:function(){return a.patient}}});b.result.then(function(b){b.dateOfReferral=new Date(b.dateOfReferral),b.dateOfReferral.setMinutes(b.dateOfReferral.getMinutes()-b.dateOfReferral.getTimezoneOffset());var c={sourceId:"",author:b.author,clinicalSummary:b.clinicalSummary,dateCreated:new Date(b.dateCreated),dateOfReferral:b.dateOfReferral,reason:b.reason,referralFrom:b.referralFrom,referralTo:b.referralTo,source:"openehr"};i.create(a.patient.id,c).then(function(){setTimeout(function(){f.go("referrals",{patientId:a.patient.id,filter:a.query,page:a.currentPage},{reload:!0})},2e3)})})}}]),angular.module("gpConnect").controller("ReferralsDetailCtrl",["$scope","$stateParams","$modal","$location","$state","Helper","usSpinnerService","PatientService","Referral",function(a,b,c,d,e,f,g,h,i){h.get(b.patientId).then(function(b){a.patient=b}),i.get(b.patientId,b.referralId).then(function(b){a.referral=b.data,g.stop("referralsDetail-spinner")}),a.edit=function(){var b=c.open({templateUrl:"views/referrals/referrals-modal.html",size:"lg",controller:"ReferralsModalCtrl",resolve:{modal:function(){return{title:"Edit Referral"}},referral:function(){return angular.copy(a.referral)},patient:function(){return a.patient}}});b.result.then(function(b){b.dateOfReferral=new Date(b.dateOfReferral),b.dateOfReferral.setMinutes(b.dateOfReferral.getMinutes()-b.dateOfReferral.getTimezoneOffset());var c={sourceId:b.sourceId,author:b.author,clinicalSummary:b.clinicalSummary,dateCreated:new Date(b.dateCreated),dateOfReferral:b.dateOfReferral,reason:b.reason,referralFrom:b.referralFrom,referralTo:b.referralTo,source:"openehr"};i.update(a.patient.id,c).then(function(){setTimeout(function(){e.go("referrals-detail",{patientId:a.patient.id,referralId:f.updateId(b.sourceId),page:a.currentPage})},2e3)})})}}]),angular.module("gpConnect").controller("ProceduresModalCtrl",["$scope","$filter","$modalInstance","UserService","patient","modal","procedure",function(a,b,c,d,e,f,g){a.currentUser=d.getCurrentUser(),a.procedure=g,a.patient=e,a.modal=f,"Create Procedure"===f.title?a.procedure.dateSubmitted=(new Date).toISOString().slice(0,10):(a.procedure.time=new Date(a.procedure.time),a.procedure.dateSubmitted=new Date(a.procedure.dateSubmitted).toISOString().slice(0,10),a.procedure.date=new Date(a.procedure.date).toISOString().slice(0,10)),a.dateofProcedureDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.dateofSubmittedDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.ok=function(b,d){a.formSubmitted=!0,b.$valid&&c.close(d)},a.cancel=function(){c.dismiss("cancel")},a.validate=function(a,b,c){var d=b+c;for(var e in a.$error.required){var f=a.$error.required[e].$name;if(f===d)return!0}},a.validateDirty=function(a,b,c){var d=b+c;return a[d].$dirty&&a[d].$invalid},a.validateClean=function(a,b,c){var d=b+c;return a[d].$dirty&&a[d].$valid}}]),angular.module("gpConnect").controller("ProceduresListCtrl",["$scope","$location","$stateParams","$modal","$state","usSpinnerService","PatientService","Procedure",function(a,b,c,d,e,f,g,h){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.search=function(b){return-1!==angular.lowercase(b.name).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.date).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.time).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.source).indexOf(angular.lowercase(a.query)||"")},g.get(c.patientId).then(function(b){a.patient=b}),c.filter&&(a.query=c.filter),h.all(c.patientId).then(function(b){a.procedures=b.data;for(var c=0;c<a.procedures.length;c++)a.procedures[c].date=moment(a.procedures[c].date).format("DD-MMM-YYYY"),a.procedures[c].time=moment(a.procedures[c].time).format("HH:mm");f.stop("patientSummary-spinner")}),a.go=function(b,c){e.go("procedures-detail",{patientId:a.patient.id,procedureId:b,filter:a.query,page:a.currentPage,source:c})},a.selected=function(a){return a===c.procedureId},a.create=function(){var b=d.open({templateUrl:"views/procedures/procedures-modal.html",size:"lg",controller:"ProceduresModalCtrl",resolve:{modal:function(){return{title:"Create Procedure"}},procedure:function(){return{}},patient:function(){return a.patient}}});b.result.then(function(b){b.dateSubmitted=new Date(b.dateSubmitted),b.date=new Date(b.date),b.date.setMinutes(b.date.getMinutes()-b.date.getTimezoneOffset()),b.time=new Date(b.time.valueOf()-6e4*b.time.getTimezoneOffset());var c={sourceId:"",procedureName:b.procedureName,procedureTerminology:b.procedureTerminology,procedureCode:b.procedureCode,notes:b.notes,author:b.author,date:b.date,time:b.time,performer:b.performer,dateSubmitted:b.dateSubmitted};h.create(a.patient.id,c).then(function(){setTimeout(function(){e.go("procedures",{patientId:a.patient.id,filter:a.query,page:a.currentPage},{reload:!0})},2e3)})})}}]),angular.module("gpConnect").controller("ProceduresDetailCtrl",["$scope","$stateParams","$modal","$state","$location","Helper","usSpinnerService","PatientService","Procedure",function(a,b,c,d,e,f,g,h,i){h.get(b.patientId).then(function(b){a.patient=b}),i.get(b.patientId,b.procedureId,b.source).then(function(b){a.procedure=b.data,g.stop("proceduresDetail-spinner")}),a.edit=function(){var e=c.open({templateUrl:"views/procedures/procedures-modal.html",size:"lg",controller:"ProceduresModalCtrl",resolve:{modal:function(){return{title:"Edit Procedure"}},procedure:function(){return angular.copy(a.procedure)},patient:function(){return a.patient}}});e.result.then(function(c){c.dateSubmitted=new Date(c.dateSubmitted),c.date=new Date(c.date),c.date.setMinutes(c.date.getMinutes()-c.date.getTimezoneOffset());var e={sourceId:c.sourceId,procedureName:c.procedureName,procedureCode:c.procedureCode,procedureTerminology:c.procedureTerminology,notes:c.notes,author:c.author,date:c.date,time:c.time,performer:c.performer,dateSubmitted:c.dateSubmitted,source:c.source};i.update(a.patient.id,e).then(function(){setTimeout(function(){d.go("procedures-detail",{patientId:a.patient.id,procedureId:"Marand"===c.source?c.updateId(medication.sourceId):c.sourceId,page:a.currentPage,source:b.source})},2e3)})})}}]),angular.module("gpConnect").controller("ResultsListCtrl",["$scope","$location","$stateParams","$modal","usSpinnerService","$state","PatientService","Result",function(a,b,c,d,e,f,g,h){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.search=function(b){return-1!==angular.lowercase(b.testName).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.sampleTaken).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.dateCreated).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.source).indexOf(angular.lowercase(a.query)||"")},c.filter&&(a.query=c.filter),g.get(c.patientId).then(function(b){a.patient=b}),h.all(c.patientId).then(function(b){a.results=b.data;for(var c=0;c<a.results.length;c++)a.results[c].sampleTaken=moment(a.results[c].sampleTaken).format("DD-MMM-YYYY"),a.results[c].dateCreated=moment(a.results[c].dateCreated).format("DD-MMM-YYYY");e.stop("patientSummary-spinner")}),a.go=function(b,c){f.go("results-detail",{patientId:a.patient.id,resultIndex:b,source:c,filter:a.query,page:a.currentPage})},a.selected=function(a){return a===c.resultIndex}}]),angular.module("gpConnect").controller("ResultsDetailCtrl",["$scope","$stateParams","$modal","$location","usSpinnerService","PatientService","Result",function(a,b,c,d,e,f,g){f.get(b.patientId).then(function(b){a.patient=b}),g.get(b.patientId,b.resultIndex,b.source).then(function(b){a.result=b.data,e.stop("resultsDetail-spinner")})}]),angular.module("gpConnect").controller("MainSearchController",["$scope","$state","$timeout","AdvancedSearch","PatientService",function(a,b,c,d,e){a.mainSearchEnabled=!0,a.searchExpression="",a.errorOccurred=!1,a.openAdvancedSearch=d.openAdvancedSearch,a.cancelSearchMode=function(){a.searchExpression=""},a.searchFunction=function(b){var c=b.replace(/\s+/g,"");isNaN(c)||10!=c.length?a.applyError():e.get(c).then(function(a){f(a.nhsNumber)})["catch"](function(){a.applyError()})},a.applyError=function(){c(function(){a.$apply(function(){a.errorOccurred=!0},1e3)})},a.removeError=function(){c(function(){a.$apply(function(){a.errorOccurred=!1},1e3)})},a.populateSearchField=function(b){c(function(){a.$apply(function(){a.searchExpression=b},1e3)})};var f=function(c){b.go("patients-summary",{patientId:c,filter:a.query})}}]),angular.module("gpConnect").controller("AdvancedSearchController",["$scope","$modalInstance","$state","modal","searchParams","AdvancedSearch",function(a,b,c,d,e,f){a.modal=d,a.searchParams=e,a.formSubmitted=!1,a.detailsFocused=!1,a.modalReopened=!1,a.searchParams.nhsNumber?a.nhsNumberFocus=!0:a.searchParams.surname?a.surnameFocus=!0:a.nhsNumberFocus=!0,a.searchParams.dateOfBirth&&(a.searchParams.dateOfBirth=new Date(a.searchParams.dateOfBirth).toISOString().slice(0,10),a.detailsFocused=!0,a.modalReopened=!0),a.cancel=function(){b.dismiss("cancel")},a.ok=function(b){b.$valid&&f.searchByDetails(a.searchParams).then(function(b){a.patients=b.data,g()})};var g=function(){a.formSubmitted=!0,b.close(),1==a.patients.length?c.go("patients-summary",{patientId:a.patients[0].nhsNumber}):a.patients.length>1?c.go("patients-list",{patientsList:a.patients,advancedSearchParams:a.searchParams}):c.go("patients-list",{patientsList:a.patients,advancedSearchParams:a.searchParams,displayEmptyTable:!0})};a.openDatePicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.isNhsNumberRequired=function(b){var c=a.advancedSearchForm.nhsNumber.$viewValue;if(void 0===c&&a.areDetailsFieldsClean(b))return!0;c=c.replace(/\s+/g,"");var d=isNaN(c)||b.nhsNumber.$invalid&&0===c.length;return d&&a.areDetailsFieldsClean(b)},a.isNhsNumberTooShort=function(a){if(void 0===a)return!1;var b=a.replace(/\s+/g,"");return!isNaN(b)&&b.length>0&&b.length<10},a.isNhsNumberTooLong=function(a){if(void 0===a)return!1;var b=a.replace(/\s+/g,"");return!isNaN(b)&&b.length>10},a.isNhsNumberFieldInvalid=function(a){return a.$invalid||a.$pristine},a.areDetailsFieldsClean=function(b){var c=b.surname,d=b.forename,e=b.dateOfBirth,f=c.$invalid||!a.searchParams.surname||""==a.searchParams.surname,g=d.$invalid||!a.searchParams.forename||""==a.searchParams.forename,h=e.$invalid||!a.searchParams.dateOfBirth||""==a.searchParams.dateOfBirth;return f&&g&&h}}]);