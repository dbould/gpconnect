"use strict";function getDayFromDate(a){var b=new Array(7);return b[0]="Sunday",b[1]="Monday",b[2]="Tuesday",b[3]="Wednesday",b[4]="Thursday",b[5]="Friday",b[6]="Saturday",b[a.getDay()]}angular.module("gpConnect",["ngResource","ngTouch","ngAnimate","ui.router","ui.bootstrap","angular-loading-bar","growlNotifications","angularUtils.directives.dirPagination","ui.timepicker","ui.calendar","angularSpinner","ui.tree","gantt","gantt.sortable","gantt.tooltips","gantt.bounds","gantt.progress","gantt.table","gantt.tree","gantt.groups"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("patients-list",{url:"/patients?ageRange&department&order&reverse",views:{main:{templateUrl:"views/patients/patients-list.html",controller:"PatientsListCtrl"}},params:{patientsList:[],advancedSearchParams:[],displayEmptyTable:!1}}).state("main-search",{url:"/search",views:{main:{templateUrl:"views/search/main-search.html",controller:"MainSearchController"}}}).state("patients-summary",{url:"/patients/{patientId:int}/patients-summary",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/patients/patients-summary.html",controller:"PatientsSummaryCtrl"}}}).state("problem-list",{url:"/patients/{patientId:int}/problem",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/problem/problem-list.html",controller:"ProblemListCtrl"}}}).state("problem-detail",{url:"/patients/{patientId:int}/problem/{problemIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/problem/problem-list.html",controller:"ProblemListCtrl"},detail:{templateUrl:"views/problem/problem-detail.html",controller:"ProblemDetailCtrl"}}}).state("allergies",{url:"/patients/{patientId:int}/allergies",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/allergies/allergies-list.html",controller:"AllergiesListCtrl"}}}).state("allergies-detail",{url:"/patients/{patientId:int}/allergies/{allergyIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/allergies/allergies-list.html",controller:"AllergiesListCtrl"},detail:{templateUrl:"views/allergies/allergies-detail.html",controller:"AllergiesDetailCtrl"}}}).state("medications",{url:"/patients/{patientId:int}/medications",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/medications/medications-list.html",controller:"MedicationsListCtrl"}}}).state("medications-detail",{url:"/patients/{patientId:int}/medications/{medicationIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/medications/medications-list.html",controller:"MedicationsListCtrl"},detail:{templateUrl:"views/medications/medications-detail.html",controller:"MedicationsDetailCtrl"}}}).state("referrals",{url:"/patients/{patientId:int}/referrals",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/referrals/referrals-list.html",controller:"ReferralsListCtrl"}}}).state("referrals-detail",{url:"/patients/{patientId:int}/referrals/{referralId}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/referrals/referrals-list.html",controller:"ReferralsListCtrl"},detail:{templateUrl:"views/referrals/referrals-detail.html",controller:"ReferralsDetailCtrl"}}}).state("observations",{url:"/patients/{patientId:int}/observations",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/observations/observations-list.html",controller:"ObservationsListCtrl"}}}).state("results-detail",{url:"/patients/{patientId:int}/results/{resultIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/results/observations-list.html",controller:"ResultsListCtrl"},detail:{templateUrl:"views/results/observations-detail.html",controller:"ResultsDetailCtrl"}}}).state("encounters",{url:"/patients/{patientId:int}/encounters",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/encounters/encounters-list.html",controller:"EncountersListCtrl"}}}).state("encounters-detail",{url:"/patients/{patientId:int}/encounters/{encounterIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/encounters/encounters-list.html",controller:"EncountersListCtrl"},detail:{templateUrl:"views/encounters/encounters-detail.html",controller:"EncountersDetailCtrl"}}}).state("immunisations",{url:"/patients/{patientId:int}/immunisations",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/immunisations/immunisations-list.html",controller:"ImmunisationsListCtrl"}}}).state("immunisations-detail",{url:"/patients/{patientId:int}/immunisations/{immunisationIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/immunisations/immunisations-list.html",controller:"ImmunisationsListCtrl"},detail:{templateUrl:"views/immunisations/immunisations-detail.html",controller:"ImmunisationsDetailCtrl"}}}).state("adminitems",{url:"/patients/{patientId:int}/adminitems",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/adminitems/adminitems-list.html",controller:"AdminItemsListCtrl"}}}).state("adminitems-detail",{url:"/patients/{patientId:int}/adminitems/{adminItemIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/adminitems/adminitems-list.html",controller:"AdminItemsListCtrl"},detail:{templateUrl:"views/adminitems/adminitems-detail.html",controller:"AdminItemsDetailCtrl"}}}).state("clinicalitems",{url:"/patients/{patientId:int}/clinicalitems",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/clinicalitems/clinicalitems-list.html",controller:"ClinicalItemsListCtrl"}}}).state("clinicalitems-detail",{url:"/patients/{patientId:int}/clinicalitems/{clinicalItemIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/clinicalitems/clinicalitems-list.html",controller:"ClinicalItemsListCtrl"},detail:{templateUrl:"views/clinicalitems/clinicalitems-detail.html",controller:"ClinicalItemsDetailCtrl"}}}).state("investigations",{url:"/patients/{patientId:int}/investigations",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/investigations/investigations-list.html",controller:"InvestigationsListCtrl"}}}).state("investigations-detail",{url:"/patients/{patientId:int}/investigations/{investigationIndex}?filter&source",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/investigations/investigations-list.html",controller:"InvestigationsListCtrl"},detail:{templateUrl:"views/investigations/investigations-detail.html",controller:"InvestigationsDetailCtrl"}}}).state("appointments",{url:"/patients/{patientId:int}/appointments",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/appointments/appointments.html",controller:"AppointmentsCtrl"}}}).state("orders-sent",{url:"/patients/{patientId:int}/orders/sent",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/orders/sent/orders-sent.html",controller:"OrdersSentCtrl"}}}).state("orders-received",{url:"/patients/{patientId:int}/orders/received",views:{"user-context":{templateUrl:"views/patients/patients-context.html",controller:"PatientsDetailCtrl"},actions:{templateUrl:"views/patients/patients-sidebar.html",controller:"PatientsDetailCtrl"},main:{templateUrl:"views/orders/received/orders-received.html",controller:"OrdersReceivedCtrl"}}})}]).directive("datepickerPopup",function(){return{restrict:"EAC",require:"ngModel",link:function(a,b,c,d){d.$formatters.unshift()}}}).directive("mySpace",function(){return function(a,b,c){b.bind("keydown keypress",function(b){32===b.which&&(a.$apply(function(){a.$eval(c.myEnter)}),b.preventDefault())})}}).directive("autoFocus",["$timeout",function(a){return{restrict:"A",require:"ngModel",scope:{ngModel:"="},link:function(b,c,d,e){b.$watch("ngModel",function(b){a(function(){c[0].focus()})})}}}]).directive("isValidNhsNumber",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){a.$watch(c.ngModel,function(a){e(a)}),d.$parsers.unshift(function(a){return e(a)});var e=function(a){if(a){var b=a.replace(/\s+/g,""),c=!isNaN(b)&&10===b.length;return d.$setValidity("invalidNHSNumFormat",c),c?b:""}}}}}).filter("formatNHSNumber",function(){return function(a){return void 0!==a?a.slice(0,3)+" "+a.slice(3,6)+" "+a.slice(6):void 0}}).constant("keyCodes",{esc:27,enter:13}).directive("keyBind",["keyCodes",function(a){function b(b){var c={};for(var d in b){var e=b[d];a.hasOwnProperty(d)&&(c[a[d]]=e)}return c}return function(a,c,d){var e=b(a.$eval(d.keyBind));c.bind("keydown keypress",function(b){e.hasOwnProperty(b.which)&&a.$apply(function(){a.$eval(e[b.which])})})}}]).directive("focusElement",["$timeout",function(a){return{link:function(b,c,d){b.$watch(d.focusElement,function(b){a(function(){b===!0&&c.focus()})})}}}]).directive("rpOnLoad",["$parse",function(a){return function(b,c,d){var e=a(d.rpOnLoad);c.on("load",function(a){b.$apply(function(){e(b,{$event:a})})})}}]).config(["datepickerConfig","datepickerPopupConfig","cfpLoadingBarProvider",function(a,b,c){a.startingDay=1,b.showButtonBar=!1,b.datepickerPopup="dd-MMM-yyyy",c.includeSpinner=!1}]).config(["paginationTemplateProvider",function(a){a.setPath("views/dirPagination.tpl.html")}]).provider("ProviderRouting",function(){var a={spineProxy:"",ASID:"",practices:[]};this.$get=function(){var b=jQuery.ajax({type:"GET",url:"/providerRouting.json",cache:!1,async:!1,contentType:"application/json",dataType:"json"});return 200===b.status&&(a=angular.fromJson(b.responseText),a.defaultPractice=function(){for(var a=$("#defaultPracticeOdsCode").html(),b=0;b<this.practices.length;b++){var c=this.practices[b];if(c.odsCode==a)return c}}),a}}),angular.module("gpConnect").value("claims",{sub:"28AD8576-1948-4C84-8B5E-55FB7EE027CE",given_name:"Bob",family_name:"Smith",email:"gpconnect@example.com",date_of_birth:"19/04/2016",scope:{setting1:!0,setting2:!0},tenant_id:"HSCIC",tenant_name:"GP Connect",role:"gpconnect"}),angular.module("gpConnect").factory("fhirJWTFactory",function(){var a=function(a,b,c){c=""+c;var d={alg:"none",typ:"JWT"},e={},f=KJUR.jws.IntDate.get("now"),g=KJUR.jws.IntDate.get("now")+3e5;g=""+g;var h=KJUR.jws.IntDate.get(g);e.iss=window.location.href,e.sub="1",e.aud="https://authorize.fhir.nhs.net/token",e.exp=h,e.iat=f,e.reason_for_request="directcare",a.indexOf("patient")>-1?(e.requested_record={resourceType:"Patient",identifier:[{system:"http://fhir.nhs.net/Id/nhs-number",value:c}]},e.requested_scope="patient/*."+b):(e.requested_record={resourceType:"Organization",identifier:[{system:"http://fhir.nhs.net/Id/ods-organization-code",value:c}]},e.requested_scope="organization/*."+b),e.requesting_device={resourceType:"Device",id:"1",identifier:[{system:"Web Interface",value:"GP Connect Demonstrator"}],model:"Demonstrator",version:"1.0"},e.requesting_organization={resourceType:"Organization",id:"1",identifier:[{system:"http://fhir.nhs.net/Id/ods-organization-code",value:"[ODSCode]"}],name:"GP Connect Demonstrator"},e.requesting_practitioner={resourceType:"Practitioner",id:"1",identifier:[{system:"http://fhir.nhs.net/sds-user-id",value:"G13579135"},{system:"localSystem",value:"1"}],name:{family:["Demonstrator"],given:["GPConnect"],prefix:["Mr"]}};var i=JSON.stringify(d),j=JSON.stringify(e),k=KJUR.jws.JWS.sign("none",i,j,"");return k},b=function(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()};return{getJWT:a,guid:b}}),angular.module("gpConnect").factory("FhirEndpointLookup",["$http","ProviderRouting",function(a,b){var c={restUrlPrefix:"",fromASID:b.ASID,toASID:""},d=function(d,e){var f=a.get(b.defaultPractice().apiEndpointURL+"/ldap/endpointLookup?odsCode="+d+"&interactionId="+e).then(function(a){var d=a.data;return d.endpointURL&&d.recievingSysASID&&(c.restUrlPrefix=b.spineProxy+d.endpointURL,c.toASID=d.recievingSysASID),c});return f};return{getEndpoint:d}}]),angular.module("gpConnect").value("content",{gpconnect_title:"GP Connect Demonstrator"}),angular.module("gpConnect").factory("UserService",["$location","$http","claims","content",function(a,b,c,d){var e={role:c.role,email:c.email,tenant:{id:c.tenant_id,name:c.tenant_name},firstName:c.given_name,surname:c.family_name,dateOfBirth:c.date_of_birth,isAuthenticated:!0,feature:c.scope},f=function(){var b=a.search();e.email=b.email||e.email,e.role=b.role||e.role},g=function(){return e},h=function(a){return d[a]};return{setCurrentUserFromQueryString:f,getCurrentUser:g,getContent:h}}]),angular.module("gpConnect").factory("PatientService",["$rootScope","$http","FhirEndpointLookup","$cacheFactory","fhirJWTFactory","ProviderRouting",function(a,b,c,d,e,f){var g=function(){return b.get(f.defaultPractice().apiEndpointURL+"/patients")},h=function(d){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+d+'" }},{"name" : "recordSection","valueString" : "SUM"},{"name" : "timePeriod","valuePeriod" : { "start" : "2015", "end" : "2016" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":e.guid(),Authorization:"Bearer "+e.getJWT("patient","read",d)}})})},i=function(d,f){var f="undefined"!=typeof f?f:a.patientOdsCode;return c.getEndpoint(f,"urn:nhs:names:services:gpconnect:fhir:rest:search:patient").then(function(a){var c=a,f=b.get(c.restUrlPrefix+"/Patient?identifier=http://fhir.nhs.net/Id/nhs-number|"+d,{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:rest:search:patient","Ssp-TraceID":e.guid(),Authorization:"Bearer "+e.getJWT("patient","read",d)}}).then(function(a){return void 0!=a.data.entry?a.data.entry[0].resource.id:void 0});return f})},j=function(d,f){return a.patientOdsCode=d,c.getEndpoint(d,"urn:nhs:names:services:gpconnect:fhir:rest:search:patient").then(function(a){var c=a,a=b.get(c.restUrlPrefix+"/Patient?identifier=http://fhir.nhs.net/Id/nhs-number|"+f,{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:rest:search:patient","Ssp-TraceID":e.guid(),Authorization:"Bearer "+e.getJWT("patient","read",f)}}).then(function(a){return void 0!=a.data.entry?a.data.entry[0].resource:void 0});return a})},k=function(a,d,f){return c.getEndpoint(a,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.registerpatient").then(function(a){return b.post(a.restUrlPrefix+"/Patient/$gpc.registerpatient",d,{headers:{"Ssp-From":a.fromASID,"Ssp-To":a.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.registerpatient","Ssp-TraceID":e.guid(),Authorization:"Bearer "+e.getJWT("patient","read",f)}}).then(function(a){return a.data})})};return{findAllSummaries:g,getSummary:h,getPatientFhirId:i,getFhirPatient:j,registerPatient:k}}]),angular.module("gpConnect").factory("Problem",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e,f){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+e+'" }},{"name" : "recordSection","valueString" : "PRB"},{"name" : "timePeriod","valuePeriod" : { "start" : "2015", "end" : "2016" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findAllHTMLTables:e}}]),angular.module("gpConnect").factory("Allergy",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e,f){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+e+'" }},{"name" : "recordSection","valueString" : "ALL"},{"name" : "timePeriod","valuePeriod" : { "start" : "2015", "end" : "2016" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findAllHTMLTables:e}}]),angular.module("gpConnect").factory("Medication",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e,f){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+e+'" }},{"name" : "recordSection","valueString" : "MED"},{"name" : "timePeriod","valuePeriod" : { "start" : "2015", "end" : "2016" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findAllHTMLTables:e}}]),angular.module("gpConnect").factory("Appointment",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory","Organization",function(a,b,c,d,e){var f=function(e,f,g){var g="undefined"!=typeof g?g:a.patientOdsCode;return c.getEndpoint(g,"urn:nhs:names:services:gpconnect:fhir:rest:search:patient_appointments").then(function(a){var c=a;return b.get(c.restUrlPrefix+"/Patient/"+f+"/Appointment",{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:rest:search:patient_appointments","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})},g=function(a,f,g,h){return e.searchForOrganisation(a,h,a).then(function(e){if(void 0!=e.data.entry){var h=e.data.entry[0].resource.id;return c.getEndpoint(a,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getschedule").then(function(c){var e=c;return b.post(e.restUrlPrefix+"/Organization/"+h+"/$gpc.getschedule",'{ "resourceType" : "Parameters", "parameter" : [ { "name" : "timePeriod", "valuePeriod" : { "start" : "'+f+'", "end" : "'+g+'" } } ] }',{headers:{"Ssp-From":e.fromASID,"Ssp-To":e.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getschedule","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("organization","read",a)}})})}})},h=function(e,f){return f.indexOf("Location")>-1?c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:rest:read:location").then(function(a){var c=a;return b.get(c.restUrlPrefix+"/"+f,{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:rest:read:location","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})}):f.indexOf("Practitioner")>-1?c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:rest:read:practitioner").then(function(a){var c=a;return b.get(c.restUrlPrefix+"/"+f,{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:rest:read:practitioner","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})}):void 0},i=function(a,e,f){return c.getEndpoint(a,"urn:nhs:names:services:gpconnect:fhir:rest:create:appointment").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Appointment",f,{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:rest:create:appointment",Authorization:"Bearer "+d.getJWT("patient","write",e),"Ssp-TraceID":d.guid(),Prefer:"return=representation"}})})},j=function(a,e,f,g){return c.getEndpoint(a,"urn:nhs:names:services:gpconnect:fhir:rest:read:appointment").then(function(a){var c=a;return b.put(c.restUrlPrefix+"/Appointment/"+f,g,{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:rest:read:appointment",Prefer:"return=representation","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","write",e)}})})};return{findAllAppointments:f,getScheduleOperation:g,findResourceByReference:h,create:i,save:j}}]),angular.module("gpConnect").factory("Referral",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e,f){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+e+'" }},{"name" : "recordSection","valueString" : "REF"},{"name" : "timePeriod","valuePeriod" : { "start" : "2015", "end" : "2016" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findAllHTMLTables:e}}]),angular.module("gpConnect").factory("DateFormatter",function(){var a=function(a){return moment(a).format("YYYY-MM-DD")};return{clean:a}}),angular.module("gpConnect").factory("Observation",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e,f){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+e+'" }},{"name" : "recordSection","valueString" : "OBS"},{"name" : "timePeriod","valuePeriod" : { "start" : "2015", "end" : "2016" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findAllHTMLTables:e}}]),angular.module("gpConnect").factory("AdvancedSearch",["$modal","$http","ProviderRouting",function(a,b,c){var d=!0,e=function(b){if(d){d=!1;var c=a.open({templateUrl:"views/search/advanced-search-modal.html",size:"lg",controller:"AdvancedSearchController",resolve:{modal:function(){return{title:"Advanced Search"}},searchParams:function(){var a={};return isNaN(b)?a.surname=b:a.nhsNumber=b,a}}})}c.result.then(function(){d=!0},function(){d=!0})},f=function(a){return b.post(c.defaultPractice().apiEndpointURL+"/patients/advancedSearch",a)};return{isModalClosed:d,openAdvancedSearch:e,searchByDetails:f}}]),angular.module("gpConnect").factory("Encounter",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e,f,g){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+e+'" }},{"name" : "recordSection","valueString" : "ENC"},{"name" : "timePeriod","valuePeriod" : { "start" : "'+f+'", "end" : "'+g+'" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findAllHTMLTables:e}}]),angular.module("gpConnect").factory("Immunisation",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+e+'" }},{"name" : "recordSection","valueString" : "IMM"},{"name" : "timePeriod","valuePeriod" : { "start" : "2015", "end" : "2016" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findAllHTMLTables:e}}]),angular.module("gpConnect").factory("AdminItem",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+e+'" }},{"name" : "recordSection","valueString" : "ADM"},{"name" : "timePeriod","valuePeriod" : { "start" : "2015", "end" : "2016" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findAllHTMLTables:e}}]),angular.module("gpConnect").factory("ClinicalItem",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+e+'" }},{"name" : "recordSection","valueString" : "CLI"},{"name" : "timePeriod","valuePeriod" : { "start" : "2015", "end" : "2016" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findAllHTMLTables:e}}]),angular.module("gpConnect").factory("Investigation",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord").then(function(a){var c=a;return b.post(c.restUrlPrefix+"/Patient/$gpc.getcarerecord",'{"resourceType" : "Parameters","parameter" : [{"name" : "patientNHSNumber","valueIdentifier" : { "value" : "'+e+'" }},{"name" : "recordSection","valueString" : "INV"},{"name" : "timePeriod","valuePeriod" : { "start" : "2015", "end" : "2016" }}]}',{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:operation:gpc.getcarerecord","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findAllHTMLTables:e}}]),angular.module("gpConnect").factory("OrderService",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory","ProviderRouting",function(a,b,c,d,e){var f=function(a){return b.get(e.defaultPractice().apiEndpointURL+"/notfhir/orders/patient/"+a+"?recieved=true&sent=false")},g=function(a){return b.get(e.defaultPractice().apiEndpointURL+"/notfhir/orders/patient/"+a+"?recieved=false&sent=true")},h=function(a,e,f){return c.getEndpoint(f,"urn:nhs:names:services:gpconnect:fhir:rest:create:order").then(function(c){var f=c;return b.post(f.restUrlPrefix+"/Order",e,{headers:{"Ssp-From":f.fromASID,"Ssp-To":f.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:rest:create:order","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","write",a)}})})},i=function(a){return b.post(e.defaultPractice().apiEndpointURL+"/notfhir/orders/order",a)};return{findAllReceivedOrders:f,findAllSentOrders:g,sendOrder:h,saveOrder:i}}]),angular.module("gpConnect").factory("Organization",["$rootScope","$http","FhirEndpointLookup","fhirJWTFactory",function(a,b,c,d){var e=function(e,f){return c.getEndpoint(a.patientOdsCode,"urn:nhs:names:services:gpconnect:fhir:rest:read:organization").then(function(a){
var c=a;return b.get(c.restUrlPrefix+"/Organization/"+f,{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:rest:read:organization","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})},f=function(a,e,f){return c.getEndpoint(a,"urn:nhs:names:services:gpconnect:fhir:rest:search:organization").then(function(a){var c=a;return b.get(c.restUrlPrefix+"/Organization?identifier=http://fhir.nhs.net/Id/ods-organization-code|"+f,{headers:{"Ssp-From":c.fromASID,"Ssp-To":c.toASID,"Ssp-InteractionID":"urn:nhs:names:services:gpconnect:fhir:rest:search:organization","Ssp-TraceID":d.guid(),Authorization:"Bearer "+d.getJWT("patient","read",e)}})})};return{findOrganisation:e,searchForOrganisation:f}}]),angular.module("gpConnect").controller("PatientsListCtrl",["$scope","$state","$stateParams","$location","$modal","PatientService",function(a,b,c,d,e,f){0!=c.patientsList.length||c.displayEmptyTable?(a.patients=c.patientsList,d.url(d.path()),a.filters={advancedSearch:!0,advancedSearchParams:c.advancedSearchParams}):(f.findAllSummaries().then(function(b){a.patients=b.data}),a.order=c.order||"name",a.reverse="true"===c.reverse,a.filters={department:c.department,ageRange:c.ageRange}),a.sort=function(d){var e=a.reverse;a.order===d&&(e=!e),b.transitionTo(b.current,_.extend(c,{order:d,reverse:e}))},a.sortClass=function(b){return a.order===b?a.reverse?"sort-desc":"sort-asc":void 0},a.go=function(c){b.go("patients-summary",{patientId:c.id,patientsList:a.patients})},a.patientFilter=function(b){return a.filters.department?b.department===a.filters.department:a.filters.ageRange?b.ageRange===a.filters.ageRange:!0},a.openAdvancedSearch=function(){e.open({templateUrl:"views/search/advanced-search-modal.html",size:"lg",controller:"AdvancedSearchController",resolve:{modal:function(){return{title:"Advanced Search"}},searchParams:function(){return c.advancedSearchParams}}})}}]),angular.module("gpConnect").controller("headerController",["$scope","$rootScope","$state","usSpinnerService","$stateParams","UserService","$modal",function(a,b,c,d,e,f,g){switch(f.setCurrentUserFromQueryString(),a.currentUser=f.getCurrentUser(),a.currentUser.role){case"gpconnect":c.go("main-search");break;case"phr":c.go("patients-summary",{patientId:9999999e3});break;default:c.go("patients-summary",{patientId:9999999e3})}b.$on("$stateChangeSuccess",function(b,d){var e="",h="",i="",j=0,k=0;switch(d.name){case"main-search":e="",h="Welcome",i="",j=12,k=0;break;case"patients-list":e="main-search",h="Patient Lists",i="Patient Dashboard",j=12,k=0;break;case"patients-summary":e="patients-list",h="Patient Summary",i="Patient Lists",j=11,k=0;break;case"patients-lookup":e="",h="Patients lookup",i="",j=6,k=6;break;default:e="patients-list",h="Patients Details",i="Patient Lists",j=11,k=0}a.pageHeader=h,a.previousState=e,a.previousPage=i,a.mainWidth=j,a.detailWidth=k,a.goBack=function(){history.back()},a.userContextViewExists="user-context"in c.current.views,a.actionsExists="actions"in c.current.views,a.go=function(a){c.go("patients-summary",{patientId:a.id})},"gpconnect"===a.currentUser.role&&(a.title=f.getContent("gpconnect_title")),"phr"===a.currentUser.role&&(a.title=f.getContent("phr_title")),a.footer=f.getContent("gpconnect_footer"),a.goHome=function(){"gpconnect"===a.currentUser.role&&c.go("main-search"),"phr"===a.currentUser.role&&c.go("patients-summary",{patientId:9999999e3})},a.gpConnectInfo=function(){g.open({templateUrl:"views/application/information-modal.html",size:"lg",controller:"InformationModalCtrl"})}})}]),angular.module("gpConnect").controller("PatientsSummaryCtrl",["$scope","$stateParams","$state","$rootScope","$location","$sce","usSpinnerService","PatientService",function(a,b,c,d,e,f,g,h){a.patients=b.patientsList,h.getSummary(b.patientId).then(function(b){var c='{"provider":"No Data","html":"No patient summary available for this patient."}';a.patientSummary=JSON.parse(c),a.patientSummary.html=f.trustAsHtml(a.patientSummary.html);var d=b.data,e=d.entry;$.each(e,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.patientSummary.html=f.trustAsHtml(c.resource.section[0].text.div),a.patientSummary.provider=c.resource.section[0].code.text)}),g.stop("patientSummary-spinner")}),a.go=function(a){e.path(a)},a.goToSection=function(a){({patientId:b.patientId})}}]),angular.module("gpConnect").controller("PatientsDetailCtrl",["$scope","$stateParams","$state","PatientService","ProviderRouting",function(a,b,c,d,e){d.getFhirPatient(e.defaultPractice().odsCode,b.patientId).then(function(b){a.patient=b,$.each(b.identifier,function(b,c){"http://fhir.nhs.net/Id/nhs-number"==c.system&&(a.patientNhsNumber=c.value)}),a.patientLocalIdentifier=b.id}),a.goTo=function(a){var d={patientId:b.patientId},e="";switch(a){case"summary":e="patients-summary";break;case"problem":e="problem-list";break;case"allergies":e="allergies";break;case"medications":e="medications";break;case"referrals":e="referrals";break;case"appointments":e="appointments";break;case"encounters":e="encounters";break;case"observations":e="observations";break;case"investigations":e="investigations";break;case"immunisations":e="immunisations";break;case"adminitems":e="adminitems";break;case"clinicalitems":e="clinicalitems";break;case"orders-sent":e="orders-sent";break;case"orders-received":e="orders-received"}c.go(e,d)}}]),angular.module("gpConnect").controller("ProblemListCtrl",["$scope","$state","$stateParams","$location","$sce","$modal","usSpinnerService","PatientService","Problem",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.search=function(b){return-1!==angular.lowercase(b.problem).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.dateOfOnset).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.source).indexOf(angular.lowercase(a.query)||"")},c.filter&&(a.query=c.filter),i.findAllHTMLTables(c.patientId).then(function(b){var c='{"provider":"No Data","html":"No problems data available for this patient."}';a.problemTable=JSON.parse(c),a.problemTable.html=e.trustAsHtml(a.problemTable.html);var d=b.data,f=d.entry;$.each(f,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.problemTable.html=e.trustAsHtml(c.resource.section[0].text.div),a.problemTable.provider=c.resource.section[0].code.text)}),g.stop("problemSummary-spinner")}),a.go=function(d,e){b.go("problem-detail",{patientId:a.patient.id,problemIndex:d,filter:a.query,page:a.currentPage,reportType:c.reportType,searchString:c.searchString,queryType:c.queryType,source:e})},a.selected=function(a){return a===c.problemIndex},a.create=function(){var c=f.open({templateUrl:"views/problem/problem-modal.html",size:"lg",controller:"ProblemModalCtrl",resolve:{modal:function(){return{title:"Create Problem"}},problem:function(){return{}},patient:function(){return a.patient}}});c.result.then(function(c){c.dateOfOnset=new Date(c.dateOfOnset);var d={code:c.code,dateOfOnset:c.dateOfOnset,description:c.description,problem:c.problem,terminology:c.terminology};i.create(a.patient.id,d).then(function(){setTimeout(function(){b.go("problem-list",{patientId:a.patient.id,filter:a.query,page:a.currentPage},{reload:!0})},2e3)})})}}]),angular.module("gpConnect").controller("ProblemDetailCtrl",["$scope","$stateParams","$location","$modal","$state","usSpinnerService","PatientService","Problem",function(a,b,c,d,e,f,g,h){h.findDetails(b.patientId,b.problemIndex,b.source).then(function(b){a.problem=b.data,f.stop("problemDetail-spinner")}),a.formDisabled=!0,a.edit=function(){var b=d.open({templateUrl:"views/problem/problem-modal.html",size:"lg",controller:"ProblemModalCtrl",resolve:{modal:function(){return{title:"Edit Problem"}},problem:function(){return angular.copy(a.problem)},patient:function(){return a.patient}}});b.result.then(function(b){var c={code:b.code,dateOfOnset:b.dateOfOnset,description:b.description,problem:b.problem,source:b.source,sourceId:b.sourceId,terminology:b.terminology};h.update(a.patient.id,c).then(function(){setTimeout(function(){e.go("problem-detail",{patientId:a.patient.id,problemIndex:b.sourceId,page:a.currentPage})},2e3)})})},a.convertToLabel=function(a){var b=a.replace(/([A-Z])/g," $1");return b.charAt(0).toUpperCase()+b.slice(1)}}]),angular.module("gpConnect").controller("ProblemModalCtrl",["$scope","$modalInstance","UserService","problem","patient","modal",function(a,b,c,d,e,f){a.currentUser=c.getCurrentUser(),a.problem=d,a.patient=e,a.modal=f,a.protocol="http://","Edit Problem"===f.title?(a.problem.dateSubmitted=(new Date).toISOString().slice(0,10),a.problem.dateOfOnset=new Date(a.problem.dateOfOnset).toISOString().slice(0,10)):(a.problem.dateSubmitted=(new Date).toISOString().slice(0,10),a.problem.code="12393890"),a.changeProtocol=function(b){switch(b){case"http":a.protocol="http://";break;case"https":a.protocol="https://";break;default:a.protocol="http://"}},a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0}}]),angular.module("gpConnect").controller("AllergiesListCtrl",["$scope","$location","$stateParams","$sce","$modal","$state","usSpinnerService","PatientService","Allergy",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.search=function(b){return-1!==angular.lowercase(b.cause).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.reaction).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.source).indexOf(angular.lowercase(a.query)||"")},c.filter&&(a.query=c.filter),i.findAllHTMLTables(c.patientId).then(function(b){var c='{"provider":"No Data","html":"No allergies data available for this patient."}';a.allergyTable=JSON.parse(c),a.allergyTable.html=d.trustAsHtml(a.allergyTable.html);var e=b.data,f=e.entry;$.each(f,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.allergyTable.html=d.trustAsHtml(c.resource.section[0].text.div),a.allergyTable.provider=c.resource.section[0].code.text)}),g.stop("allergySummary-spinner")}),a.go=function(b,c){f.go("allergies-detail",{patientId:a.patient.id,allergyIndex:b,filter:a.query,page:a.currentPage,source:c})},a.selected=function(a){return a===c.allergyIndex},a.create=function(){var b=e.open({templateUrl:"views/allergies/allergies-modal.html",size:"lg",controller:"AllergiesModalCtrl",resolve:{modal:function(){return{title:"Create Allergy"}},allergy:function(){return{}},patient:function(){return a.patient}}});b.result.then(function(b){var c={sourceId:"",cause:b.cause,causeCode:b.causeCode,causeTerminology:b.causeTerminology,reaction:b.reaction,source:b.source};i.create(a.patient.id,c).then(function(){setTimeout(function(){f.go("allergies",{patientId:a.patient.id,filter:a.query,page:a.currentPage},{reload:!0})},2e3)})})}}]),angular.module("gpConnect").controller("AllergiesDetailCtrl",["$scope","$stateParams","$modal","$state","$location","usSpinnerService","PatientService","Allergy",function(a,b,c,d,e,f,g,h){h.findDetails(b.patientId,b.allergyIndex,b.source).then(function(b){a.allergy=b.data,f.stop("allergiesDetail-spinner")}),a.edit=function(){var b=c.open({templateUrl:"views/allergies/allergies-modal.html",size:"lg",controller:"AllergiesModalCtrl",resolve:{modal:function(){return{title:"Edit Allergy"}},allergy:function(){return angular.copy(a.allergy)},patient:function(){return a.patient}}});b.result.then(function(b){var c={sourceId:b.sourceId,cause:b.cause,causeCode:b.causeCode,causeTerminology:b.causeTerminology,reaction:b.reaction,source:b.source};h.update(a.patient.id,c).then(function(){setTimeout(function(){d.go("allergies-detail",{patientId:a.patient.id,allergyIndex:b.sourceId,page:a.currentPage})},2e3)})})}}]),angular.module("gpConnect").controller("AllergiesModalCtrl",["$scope","$modalInstance","allergy","UserService","patient","modal",function(a,b,c,d,e,f){a.currentUser=d.getCurrentUser(),a.allergy=c,a.patient=e,a.modal=f,"Create Allergy"===f.title?(a.allergy.dateCreated=(new Date).toISOString().slice(0,10),a.allergy.causeCode="1239085",a.allergy.terminologyCode="12393890"):a.allergy.dateCreated=new Date(a.allergy.dateCreated).toISOString().slice(0,10),a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0}}]),angular.module("gpConnect").controller("MedicationsListCtrl",["$scope","$location","$stateParams","$modal","$state","$sce","usSpinnerService","PatientService","Medication",function(a,b,c,d,e,f,g,h,i){a.query={},a.queryBy="$",a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),c.filter&&(a.query.$=c.filter),i.findAllHTMLTables(c.patientId).then(function(b){var c='{"provider":"No Data","html":"No medication data available for this patient."}';a.medicationTable=JSON.parse(c),a.medicationTable.html=f.trustAsHtml(a.medicationTable.html);var d=b.data,e=d.entry;$.each(e,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.medicationTable.html=f.trustAsHtml(c.resource.section[0].text.div),a.medicationTable.provider=c.resource.section[0].code.text)}),g.stop("medicationSummary-spinner")}),a.go=function(b,c){e.go("medications-detail",{patientId:a.patient.id,medicationIndex:b,filter:a.query.$,page:a.currentPage,source:c})},a.selected=function(a){return a===c.medicationIndex},a.create=function(){var b=d.open({templateUrl:"views/medications/medications-modal.html",size:"lg",controller:"MedicationsModalCtrl",resolve:{modal:function(){return{title:"Create Medication"}},medication:function(){return{}},patient:function(){return a.patient}}});b.result.then(function(b){b.startDate=new Date(b.startDate),b.startTime=new Date(b.startTime.valueOf()-6e4*b.startTime.getTimezoneOffset());var c={doseAmount:b.doseAmount,doseDirections:b.doseDirections,doseTiming:b.doseTiming,medicationCode:b.medicationCode,medicationTerminology:b.medicationTerminology,name:b.name,route:b.route,startDate:b.startDate,startTime:b.startTime,author:b.author,dateCreated:b.dateCreated};i.create(a.patient.id,c).then(function(){setTimeout(function(){e.go("medications",{patientId:a.patient.id,filter:a.query.$,page:a.currentPage},{reload:!0})},2e3)})})}}]),angular.module("gpConnect").controller("MedicationsDetailCtrl",["$scope","$stateParams","$modal","$location","$state","usSpinnerService","PatientService","Medication",function(a,b,c,d,e,f,g,h){h.findDetails(b.patientId,b.medicationIndex,b.source).then(function(b){a.medication=b.data,f.stop("medicationsDetail-spinner")}),a.edit=function(){var b=c.open({templateUrl:"views/medications/medications-modal.html",size:"lg",controller:"MedicationsModalCtrl",resolve:{modal:function(){return{title:"Edit Medication"}},medication:function(){return angular.copy(a.medication)},patient:function(){return a.patient}}});b.result.then(function(b){b.startDate=new Date(b.startDate);var c={sourceId:b.sourceId,doseAmount:b.doseAmount,route:b.route,doseDirections:b.doseDirections,doseTiming:b.doseTiming,medicationCode:b.medicationCode,medicationTerminology:b.medicationTerminology,name:b.name,startDate:b.startDate,startTime:b.startTime,source:b.source};h.update(a.patient.id,c).then(function(){setTimeout(function(){e.go("medications-detail",{patientId:a.patient.id,medicationIndex:b.sourceId,page:a.currentPage})},2e3)})})}}]),angular.module("gpConnect").controller("MedicationsModalCtrl",["$scope","$modalInstance","UserService","medication","patient","modal",function(a,b,c,d,e,f){a.currentUser=c.getCurrentUser(),a.medication=d,a.patient=e,a.modal=f,a.routes=["Po Per Oral","IV Intra Venous","PN Per Nasal","PR Per Rectum","SL Sub Lingual","SC Sub Cutaneous","IM Intra Muscular"],"Edit Medication"===f.title?(a.medication.startTime=new Date(a.medication.startTime),a.medication.startDate=new Date(a.medication.startDate).toISOString().slice(0,10),a.medication.dateCreated=new Date(a.medication.dateCreated).toISOString().slice(0,10)):(a.medication.medicationCode=void 0==a.medication.medicationCode?"123456789":a.medication.medicationCode,a.medication.dateCreated=(new Date).toISOString().slice(0,10)),a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0}}]),angular.module("gpConnect").controller("AppointmentsPatientCreateModalCtrl",["$stateParams","$scope","$modal","$modalInstance","patient","appointmentBookingParameters","PatientService","usSpinnerService","DateFormatter",function(a,b,c,d,e,f,g,h,i){b.patientDetails=e,b.appointmentBooking=f,b.ok=function(){b.validationError="",h.spin("patientCreate-spinner");var e={};e.resourceType="Patient",e.modifierExtension=[{url:"http://fhir.nhs.net/StructureDefinition/extension-registration-period-1",valuePeriod:{start:i.clean(new Date)}},{url:"http://fhir.nhs.net/StructureDefinition/extension-registration-status-1",valueCodeableConcept:{coding:[{system:"http://fhir.nhs.net/ValueSet/registration-status-1",code:"A",display:"Active"}]}},{url:"http://fhir.nhs.net/StructureDefinition/extension-registration-type-1",valueCodeableConcept:{coding:[{system:"http://fhir.nhs.net/ValueSet/registration-type-1",code:"T",display:"Temporary Resident"}]}}],e.identifier=b.patientDetails.identifier,e.name=b.patientDetails.name,e.gender=b.patientDetails.gender,e.birthDate=b.patientDetails.birthDate,g.registerPatient(f.location.odsCode,e,a.patientId).then(function(a){h.stop("patientCreate-spinner"),d.close(),c.open({templateUrl:"views/appointments/appointments-create-modal.html",size:"md",controller:"AppointmentsCreateModalCtrl",resolve:{modal:function(){return{title:"Book Appointment"}},patient:function(){return b.patientDetails},appointmentBookingParams:function(){return f.patientFhirId=a.id,f}}})},function(a){h.stop("patientCreate-spinner"),b.validationError="Failed to create patient on remote system"})},b.cancel=function(){d.dismiss("cancel")}}]),angular.module("gpConnect").controller("AppointmentsCtrl",["$scope","$http","$stateParams","$state","$modal","$q","PatientService","usSpinnerService","Appointment","ProviderRouting","FhirEndpointLookup",function(a,b,c,d,e,f,g,h,i,j,k){function l(){a.appointments=[],a.allPractices=j.practices,$.each(a.allPractices,function(b,d){void 0==a.searchCount?a.searchCount=1:a.searchCount++,d.statusMsg="Searching",d.status="Searching",g.getFhirPatient(d.odsCode,c.patientId).then(function(b){i.findAllAppointments(c.patientId,b.id,d.odsCode).then(function(b){var c=b.data.entry;void 0!=c?($.each(c,function(a,b){b.appointmentPractice=d.name,b.appointmentPracticeOdsCode=d.odsCode}),a.appointments=a.appointments.concat(c),d.statusMsg="Appointments found",d.status="Success",m()):(d.statusMsg="No appointments found",d.status="Success",m())},function(a){d.statusMsg="Failed appointment search",d.status="Failed",m()})},function(a){d.statusMsg="Failed to find patient",d.status="Failed",m()})})}function m(){a.searchCount--,a.searchCount<=0&&(void 0!=a.appointments&&(a.appointments=a.appointments.sort(function(a,b){return a.resource.start.localeCompare(b.resource.start)}),$.each(a.appointments,function(a,b){if(void 0!=b.resource.modifierExtension)for(var c=0;c<b.resource.modifierExtension.length;c++)"http://fhir.nhs.net/StructureDefinition/extension-gpconnect-appointment-cancellation-reason-1-0"==b.resource.modifierExtension[c].url&&(b.cancellationReason=b.resource.modifierExtension[c].valueString,c=b.resource.modifierExtension.length)})),h.stop("patientSummary-spinner"))}a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),c.filter&&(a.query=c.filter),l(),a.go=function(b){h.spin("patientSummary-spinner"),a.appointmentDetail=void 0,a.appointmentLocation=void 0,a.practitionerName=void 0;for(var d,e=0;e<a.appointments.length;++e)if(d=a.appointments[e],d.resource.id==b){a.appointmentDetail=d;break}$.each(a.appointmentDetail.resource.participant,function(b,d){var e=d.actor.reference.toString();-1!=e.indexOf("Location")?i.findResourceByReference(c.patientId,e).then(function(b){a.appointmentLocation=b.data.name}):-1!=e.indexOf("Practitioner")&&i.findResourceByReference(c.patientId,e).then(function(b){a.practitionerName=b.data.name.prefix[0]+" "+b.data.name.given[0]+" "+b.data.name.family[0]})}),h.stop("patientSummary-spinner")},a.selected=function(a){return a===c.appointmentIndex},a.cancelAppointment=function(){e.open({templateUrl:"views/appointments/appointments-cancel-modal.html",size:"md",controller:"AppointmentsCancelModalCtrl",resolve:{appointment:function(){return{appointmentResource:a.appointmentDetail,practitionerName:a.practitionerName,appointmentLocation:a.appointmentLocation}}}})},a.amendAppointment=function(){e.open({templateUrl:"views/appointments/appointments-amend-modal.html",size:"md",controller:"AppointmentsAmendModalCtrl",resolve:{appointment:function(){return{appointmentResource:a.appointmentDetail,practitionerName:a.practitionerName,appointmentLocation:a.appointmentLocation}}}})},a.create=function(){e.open({templateUrl:"views/appointments/appointments-search-modal.html",size:"md",controller:"AppointmentsSearchModalCtrl",resolve:{modal:function(){return{title:"Appointment Search"}}}})}}]),angular.module("gpConnect").controller("AppointmentsSlotsCtrl",["$stateParams","$scope","usSpinnerService","Appointment","appointmentSearchParams","$modalInstance","$modal","modal","PatientService","ProviderRouting",function(a,b,c,d,e,f,g,h,i,j){i.getFhirPatient(j.defaultPractice().odsCode,a.patientId).then(function(a){b.patientDetails=a}),b.selectedSlots=[];var k={ADJACENT:0,NOTADJACENT:1,SAMESLOT:2,SAMESLOTMIDDLE:3},l=0;c.spin("appointmentSlots-spinner"),b.ganttModel=[],b.ganttHeaderFormats={day:"DD MMMM YYYY",hour:"HH:mm"};var m={};b.practicesSearchingAndFails=[];var n=moment(e.startDate).format("YYYY-MM-DDTHH:mm:ss"),o=moment(e.endDate).add(23,"hours").add(59,"minutes").add(59,"seconds").format("YYYY-MM-DDTHH:mm:ss"),p=function(e,f,g,h,i){var j={};j.practiceName=f,j.practiceOdsCode=e,j.status="Searching",b.practicesSearchingAndFails.push(j),l++,c.spin("appointmentSlots-spinner");var k=[],n={},o={},p={};d.getScheduleOperation(e,g,h,a.patientId).then(function(a){var d=a.data;if($.each(d.entry,function(a,b){if("Slot"==b.resource.resourceType){var c={scheduleRef:b.resource.schedule.reference,startDateTime:b.resource.start,endDateTime:b.resource.end,type:b.resource.type.coding[0].display,typeCode:b.resource.type.coding[0].code,id:b.resource.id};k.push(c)}if("Schedule"==b.resource.resourceType&&(n[b.fullUrl]={locationRef:b.resource.actor.reference,practitionerRef:b.resource.modifierExtension[0].valueReference.reference}),"Practitioner"==b.resource.resourceType){var d="",e="",f="";void 0!=b.resource.name.prefix&&(d=b.resource.name.prefix[0]),void 0!=b.resource.name.given&&(e=b.resource.name.given[0]),void 0!=b.resource.name.family&&(f=b.resource.name.family[0]);var g=d+" "+e+" "+f;o[b.fullUrl]={fullName:g,id:b.resource.id}}"Location"==b.resource.resourceType&&(p[b.fullUrl]={name:b.resource.name,id:b.resource.id})}),k.length>0&&($.each(k,function(a,b){var c={startDateTime:new Date(b.startDateTime),endDateTime:new Date(b.endDateTime),type:b.type,typeCode:b.typeCode,id:b.id},d=n[b.scheduleRef],g=o[d.practitionerRef].fullName,h=o[d.practitionerRef].id,j=p[d.locationRef].name,k=p[d.locationRef].id;if(void 0==m.locations){var l=[];l.push(c);var q=[],r={fullName:g,slots:l,id:h};q.push(r);var s=[],t=new Date(c.startDateTime),u={dayOfWeek:getDayFromDate(c.startDateTime),date:t.setHours(0,0,0,0),freeSlots:1,practitioners:q};s.push(u);var v=[],w={name:j,freeSlots:1,dayBlockOfSlots:s,id:k,odsCode:e,practiceName:f,primary:i};v.push(w),m.locations=v}else{for(var x=-1,y=0;y<m.locations.length;y++)if(k==m.locations[y].id&&e==m.locations[y].odsCode){x=y;break}if(-1==x){var l=[];l.push(c);var q=[],r={fullName:g,slots:l,id:h};q.push(r);var s=[],t=new Date(c.startDateTime),u={dayOfWeek:getDayFromDate(c.startDateTime),date:t.setHours(0,0,0,0),freeSlots:1,practitioners:q},w={name:j,freeSlots:1,dayBlockOfSlots:s,id:k,odsCode:e,practiceName:f,primary:i};m.locations.push(w)}else{m.locations[x].freeSlots++;for(var z=-1,y=0;y<m.locations[x].dayBlockOfSlots.length;y++){var t=new Date(c.startDateTime);if(t.setHours(0,0,0,0)==m.locations[x].dayBlockOfSlots[y].date){z=y;break}}if(-1==z){var l=[];l.push(c);var q=[],r={fullName:g,slots:l,id:h};q.push(r);var s=[],t=new Date(c.startDateTime),u={dayOfWeek:getDayFromDate(c.startDateTime),date:t.setHours(0,0,0,0),freeSlots:1,practitioners:q};m.locations[x].dayBlockOfSlots.push(u)}else{m.locations[x].dayBlockOfSlots[z].freeSlots++;for(var A=-1,y=0;y<m.locations[x].dayBlockOfSlots[z].practitioners.length;y++)if(h==m.locations[x].dayBlockOfSlots[z].practitioners[y].id){A=y;break}if(-1==A){var l=[];l.push(c);var r={fullName:g,slots:l,id:h};m.locations[x].dayBlockOfSlots[z].practitioners.push(r)}else m.locations[x].dayBlockOfSlots[z].practitioners[A].slots.push(c)}}}}),b.scheduleModel=m,b.selectDefaultLocation(m.locations),setTimeout(function(){$(".gantt-scrollable").scrollLeft(100)},10)),l--,0>=l&&c.stop("appointmentSlots-spinner"),k.length>0){var g=b.practicesSearchingAndFails.indexOf(j);b.practicesSearchingAndFails.splice(g,1),j.status="Success"}else j.status="No Slots"},function(a){j.status="Failed",l--,0>=l&&c.stop("appointmentSlots-spinner")})};1==e.primaryPractice.checked&&p(e.primaryPractice.odsCode,e.primaryPractice.name,n,o,!0),$.each(e.federatedPractices,function(a,b){1==b.checked&&p(b.odsCode,b.name,n,o,!1)}),b.loadDaySlots=function(a){b.ganttModel=[];for(var c=a.practitioners,d=0;d<c.length;d++){for(var e={id:c[d].id,name:c[d].fullName,height:"3em",sortable:!1,tasks:[]},f=c[d].slots,g=0;g<f.length;g++){var h={name:f[g].type,typeCode:f[g].typeCode,color:"#99ccff",from:f[g].startDateTime,to:f[g].endDateTime,id:f[g].id};e.tasks.push(h)}b.ganttModel.push(e),b.displayFromDate=a.date,b.displayToDate=a.date}},b.onSelectLocation=function(a){b.selectedLocation=a,b.selectDefaultDay(a),r()},b.isLocationSelected=function(a){return a===b.selectedLocation},b.selectDefaultLocation=function(a){if(a.length>0){for(var c=a[0],d=0;d<a.length;d++)1==a[d].primary&&(c=a[d],d=a.length);b.onSelectLocation(c)}},b.isDaySelected=function(a){return a===b.selectedDay},b.onSelectDay=function(a){b.selectedDay=a,b.loadDaySlots(a),r()},b.selectDefaultDay=function(a){if(a.dayBlockOfSlots.length>0){var c=a.dayBlockOfSlots[0];b.onSelectDay(c)}},b.cancel=function(){f.dismiss("cancel")},b.getFormattedDate=function(a){var b=new Date(a.date),c={weekday:"short",year:"2-digit",month:"short",day:"numeric"},d=b.toLocaleString("en-GB",c);return d},b.bookAppointment=function(){b.selectedSlots.length<=0&&alert("You must select slots before booking an appointment"),c.spin("appointmentSlots-spinner");for(var d=b.selectedSlots[0].model.from,e=b.selectedSlots[0].model.to,h=[],j=0;j<b.selectedSlots.length;j++)h.push(b.selectedSlots[j].model.id),b.selectedSlots[j].model.from.isBefore(d)&&(d=b.selectedSlots[j].model.from),b.selectedSlots[j].model.to.isAfter(e)&&(e=b.selectedSlots[j].model.to);b.appointmentBookingParameters={},b.appointmentBookingParameters.location=b.selectedLocation,b.appointmentBookingParameters.slotIds=h,b.appointmentBookingParameters.startTime=d,b.appointmentBookingParameters.endTime=e,b.appointmentBookingParameters.practitionerId=b.selectedSlots[0].row.model.id,b.appointmentBookingParameters.practitionerFullName=b.selectedSlots[0].row.model.name,b.appointmentBookingParameters.locationId=b.selectedLocation.id,b.appointmentBookingParameters.typeCode=b.selectedSlots[0].model.typeCode,b.appointmentBookingParameters.type=b.selectedSlots[0].model.name,i.getPatientFhirId(a.patientId,b.appointmentBookingParameters.location.odsCode).then(function(a){void 0==a?(c.stop("appointmentSlots-spinner"),f.close(),g.open({templateUrl:"views/appointments/appointments-patient-create-modal.html",size:"md",controller:"AppointmentsPatientCreateModalCtrl",resolve:{patient:function(){return b.patientDetails},appointmentBookingParameters:function(){return b.appointmentBookingParameters}}})):(c.stop("appointmentSlots-spinner"),f.close(),g.open({templateUrl:"views/appointments/appointments-create-modal.html",size:"md",controller:"AppointmentsCreateModalCtrl",resolve:{modal:function(){return{title:"Book Appointment"}},appointmentBookingParams:function(){return b.appointmentBookingParameters.patientFhirId=a,b.appointmentBookingParameters}}}))},function(a){alert(b.appointmentBookingParameters.location.practiceName+" cannot be connected to at this current time"),f.dismiss("cancel")})};var q=function(a){if(b.selectedSlots.length>0){if(b.selectedSlots[0].row.model.id!=a.row.model.id)return k.NOTADJACENT;for(var c=!1,d=!1,e=!1,f=0;f<b.selectedSlots.length;f++)a.model.from.isSame(b.selectedSlots[f].model.from)&&a.model.to.isSame(b.selectedSlots[f].model.to)&&(c=!0),a.model.from.seconds(0).milliseconds(0).isSame(b.selectedSlots[f].model.to.seconds(0).milliseconds(0))&&(d=!0),a.model.to.seconds(0).milliseconds(0).isSame(b.selectedSlots[f].model.from.seconds(0).milliseconds(0))&&(e=!0);return c&&d&&e?k.SAMESLOTMIDDLE:!c||d&&e?d||e?k.ADJACENT:k.NOTADJACENT:k.SAMESLOT}return k.ADJACENT},r=function(){b.selectedSlots=[],$(".selectedSlot").removeClass("selectedSlot")};b.registerEventFunctions=function(a){a.directives.on["new"](b,function(a,c,d,e,f){"ganttTask"===a&&(d.bind("click",function(a){var d=q(c.task);if(d==k.ADJACENT)b.selectedSlots.push(c.task),$(this).addClass("selectedSlot");else if(d==k.SAMESLOT){var e=b.selectedSlots;b.selectedSlots=[];for(var f=0;f<e.length;f++)e[f].model.id!=c.task.model.id&&b.selectedSlots.push(e[f]);$(this).removeClass("selectedSlot")}else d==k.SAMESLOTMIDDLE?r():(r(),$(this).addClass("selectedSlot"),b.selectedSlots.push(c.task));$(".removeSelectedSlot").removeClass("removeSelectedSlot")}),d.bind("mouseenter",function(a){var b=q(c.task);b==k.NOTADJACENT||b==k.SAMESLOTMIDDLE?$(".selectedSlot").addClass("removeSelectedSlot"):b==k.SAMESLOT&&$(this).addClass("removeSelectedSlot")}),d.bind("mouseleave",function(a){$(".selectedSlot").removeClass("removeSelectedSlot")}))})}}]),angular.module("gpConnect").controller("AppointmentsSearchModalCtrl",["$scope","$modalInstance","$modal","$timeout","modal","ProviderRouting",function(a,b,c,d,e,f){a.modal=e,a.appointmentSearch={},a.appointmentSearch.primaryPractice=f.defaultPractice(),a.appointmentSearch.primaryPractice.checked=!0,a.appointmentSearch.federatedPractices=[],$.each(f.practices,function(b,c){c.odsCode!=a.appointmentSearch.primaryPractice.odsCode&&(c.checked=!1,a.appointmentSearch.federatedPractices.push(c))}),a.openDatePicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.initaliseDates=function(){a.minStartDate=new Date,a.endDateInvalid=!1},a.initaliseDates(),a.onStartDate=function(){var b=a.appointmentSearch.startDate;a.minEndDate=b;var c=moment(b).add(2,"weeks");a.maxEndDate=c.toDate();var d=a.appointmentSearch.endDate;d&&moment(c).isBefore(d)&&(a.appointmentSearch.endDate=null,a.endDateInvalid=!0)},a.onEndDate=function(){var b=a.appointmentSearch.endDate;if(b){var c=moment(a.maxEndDate);(c.isSame(b)||c.isAfter(b))&&(a.endDateInvalid=!1)}},a.$watch("appointmentSearch.startDate",function(b,c){void 0!==a.appointmentSearch&&a.onStartDate()}),a.$watch("appointmentSearch.endDate",function(b,c){void 0!==a.appointmentSearch&&a.onEndDate()}),a.ok=function(d){a.formSubmitted=!0;var e=a.appointmentSearch;
d.$valid&&(b.close(),c.open({templateUrl:"views/appointments/appointments-slots-modal.html",size:"lg",controller:"AppointmentsSlotsCtrl",resolve:{modal:function(){return{title:"Available Appointments"}},appointmentSearchParams:function(){return e}}}))},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("gpConnect").controller("AppointmentsCreateModalCtrl",["$state","$scope","$stateParams","$modalInstance","modal","appointmentBookingParams","Appointment","usSpinnerService",function(a,b,c,d,e,f,g,h){b.modal=e,b.practitionerName=f.practitionerFullName,b.practiceName=f.location.practiceName,b.locationName=f.location.name,b.appointmentCreate={},b.appointmentCreate.resourceType="Appointment",b.appointmentCreate.status="booked",b.appointmentCreate.type={coding:[{system:"http://hl7.org/fhir/ValueSet/c80-practice-codes",code:f.typeCode,display:f.type}],text:f.type},b.appointmentCreate.reason={coding:[{system:"http://snomed.info/sct",code:"00001",display:"Default Appointment Type"}],text:"Generic Booking"},b.appointmentCreate.description="",b.appointmentCreate.start=f.startTime,b.appointmentCreate.end=f.endTime,b.appointmentCreate.slot=[];for(var i=0;i<f.slotIds.length;i++){var j={reference:"Slot/"+f.slotIds[i]};b.appointmentCreate.slot.push(j)}b.appointmentCreate.comment="",b.appointmentCreate.participant=[{actor:{reference:"Patient/"+f.patientFhirId},status:"accepted"},{actor:{reference:"Practitioner/"+f.practitionerId},status:"accepted"},{actor:{reference:"Location/"+f.locationId},status:"accepted"}],b.ok=function(e){b.validationError="",b.formSubmitted=!0,e.$valid&&(h.spin("appointmentCreate-spinner"),g.create(f.location.odsCode,c.patientId,b.appointmentCreate).then(function(c){"201"!=c.status&&(b.validationError="An error occurred storing appointment, please try booking again"),d.close(),a.reload(),h.stop("appointmentCreate-spinner")}))},b.cancel=function(){d.dismiss("cancel")}}]),angular.module("gpConnect").controller("AppointmentsCancelModalCtrl",["$state","$stateParams","$scope","$modalInstance","$modal","usSpinnerService","appointment","Appointment",function(a,b,c,d,e,f,g,h){if(c.appointmentCancel=g,c.validationError="",c.cancelReasonIndex=-1,void 0!=c.appointmentCancel.appointmentResource.resource.modifierExtension)for(var i=0;i<c.appointmentCancel.appointmentResource.resource.modifierExtension.length;i++)"http://fhir.nhs.net/StructureDefinition/extension-gpconnect-appointment-cancellation-reason-1-0"==c.appointmentCancel.appointmentResource.resource.modifierExtension[i].url&&(c.cancelReasonIndex=i,i=c.appointmentCancel.appointmentResource.resource.modifierExtension.length);-1==c.cancelReasonIndex&&(c.appointmentCancel.appointmentResource.resource.modifierExtension=[{url:"http://fhir.nhs.net/StructureDefinition/extension-gpconnect-appointment-cancellation-reason-1-0",valueString:""}],c.cancelReasonIndex=0),c.cancelAppointment=function(e){c.formSubmitted=!0,c.appointmentCancel.appointmentResource.resource.modifierExtension[c.cancelReasonIndex].valueString.length>0?(f.spin("appointmentCancel-spinner"),h.save(c.appointmentCancel.appointmentResource.appointmentPracticeOdsCode,b.patientId,c.appointmentCancel.appointmentResource.resource.id,c.appointmentCancel.appointmentResource.resource).then(function(a){"200"!=a.status&&alert("An error occurred updating appointment, please try cancelling again")}),d.close(),a.reload(),f.stop("appointmentCancel-spinner")):c.validationError="A cancellation reason is required."},c.close=function(){d.dismiss("cancel")}}]),angular.module("gpConnect").controller("AppointmentsAmendModalCtrl",["$state","$stateParams","$scope","$modalInstance","$modal","usSpinnerService","appointment","Appointment",function(a,b,c,d,e,f,g,h){if(c.appointmentAmend=g,c.validationError="",c.cancelReasonIndex=-1,void 0!=c.appointmentAmend.appointmentResource.resource.modifierExtension)for(var i=0;i<c.appointmentAmend.appointmentResource.resource.modifierExtension.length;i++)"http://fhir.nhs.net/StructureDefinition/extension-gpconnect-appointment-cancellation-reason-1-0"==c.appointmentAmend.appointmentResource.resource.modifierExtension[i].url&&(c.cancelReasonIndex=i,i=c.appointmentAmend.appointmentResource.resource.modifierExtension.length);c.commentDisplayText=c.appointmentAmend.appointmentResource.resource.comment,c.amendAppointment=function(e){c.formSubmitted=!0,-1!=c.cancelReasonIndex?c.appointmentAmend.appointmentResource.resource.modifierExtension[c.cancelReasonIndex].valueString.length>0?(f.spin("appointmentAmend-spinner"),h.save(c.appointmentAmend.appointmentResource.appointmentPracticeOdsCode,b.patientId,c.appointmentAmend.appointmentResource.resource.id,c.appointmentAmend.appointmentResource.resource).then(function(a){"200"!=a.status&&alert("An error occurred updating appointment, please try cancelling again")}),d.close(),a.reload(),f.stop("appointmentAmend-spinner")):c.validationError="Cancellation reason cannot be blank":c.commentDisplayText.length>0?(c.appointmentAmend.appointmentResource.resource.comment=c.commentDisplayText,f.spin("appointmentAmend-spinner"),h.save(c.appointmentAmend.appointmentResource.appointmentPracticeOdsCode,b.patientId,c.appointmentAmend.appointmentResource.resource.id,c.appointmentAmend.appointmentResource.resource).then(function(a){"200"!=a.status&&alert("An error occurred updating appointment, please try cancelling again")}),d.close(),a.reload(),f.stop("appointmentAmend-spinner")):c.validationError="A comment is required."},c.close=function(){d.dismiss("cancel")}}]),angular.module("gpConnect").controller("ReferralsModalCtrl",["$scope","$modalInstance","UserService","referral","patient","modal",function(a,b,c,d,e,f){$("#dateofreferral").datepicker({dateFormat:"dd-MMM-y"}),a.currentUser=c.getCurrentUser(),a.referral=d,a.patient=e,a.modal=f,"Create Referral"===f.title?(a.referral.dateCreated=(new Date).toISOString().slice(0,10),a.author=a.currentUser):(a.referral.dateCreated=new Date(a.referral.dateCreated).toISOString().slice(0,10),a.referral.dateOfReferral=new Date(a.referral.dateOfReferral).toISOString().slice(0,10)),a.referralCreatedDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.dateofReferralDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.ok=function(c,d){a.formSubmitted=!0,c.$valid&&b.close(d)},a.cancel=function(){b.dismiss("cancel")},a.openDatepicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.validate=function(a,b,c){var d=b+c;for(var e in a.$error.required){var f=a.$error.required[e].$name;if(f===d)return!0}},a.validateDirty=function(a,b,c){var d=b+c;return a[d].$dirty&&a[d].$invalid},a.validateClean=function(a,b,c){var d=b+c;return a[d].$dirty&&a[d].$valid}}]),angular.module("gpConnect").controller("ReferralsListCtrl",["$scope","$location","$stateParams","$sce","$modal","$state","usSpinnerService","PatientService","Referral",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.search=function(b){return-1!==angular.lowercase(b.dateOfReferral).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.referralFrom).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.referralTo).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.source).indexOf(angular.lowercase(a.query)||"")},c.filter&&(a.query=c.filter),i.findAllHTMLTables(c.patientId).then(function(b){var c='{"provider":"No Data","html":"No referrals data available for this patient."}';a.referralTable=JSON.parse(c),a.referralTable.html=d.trustAsHtml(a.referralTable.html);var e=b.data,f=e.entry;$.each(f,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.referralTable.html=d.trustAsHtml(c.resource.section[0].text.div),a.referralTable.provider=c.resource.section[0].code.text)}),g.stop("patientSummary-spinner")}),a.go=function(b){f.go("referrals-detail",{patientId:a.patient.id,referralId:b,filter:a.query,page:a.currentPage})},a.selected=function(a){return a===c.referralId},a.create=function(){var b=e.open({templateUrl:"views/referrals/referrals-modal.html",size:"lg",controller:"ReferralsModalCtrl",resolve:{modal:function(){return{title:"Create Referral"}},referral:function(){return{}},patient:function(){return a.patient}}});b.result.then(function(b){b.dateOfReferral=new Date(b.dateOfReferral),b.dateOfReferral.setMinutes(b.dateOfReferral.getMinutes()-b.dateOfReferral.getTimezoneOffset());var c={author:b.author,clinicalSummary:b.clinicalSummary,dateCreated:new Date(b.dateCreated),dateOfReferral:b.dateOfReferral,reason:b.reason,referralFrom:b.referralFrom,referralTo:b.referralTo};i.create(a.patient.id,c).then(function(){setTimeout(function(){f.go("referrals",{patientId:a.patient.id,filter:a.query,page:a.currentPage},{reload:!0})},2e3)})})}}]),angular.module("gpConnect").controller("ReferralsDetailCtrl",["$scope","$stateParams","$modal","$location","$state","usSpinnerService","PatientService","Referral",function(a,b,c,d,e,f,g,h){h.findDetails(b.patientId,b.referralId).then(function(b){a.referral=b.data,f.stop("referralsDetail-spinner")}),a.edit=function(){var b=c.open({templateUrl:"views/referrals/referrals-modal.html",size:"lg",controller:"ReferralsModalCtrl",resolve:{modal:function(){return{title:"Edit Referral"}},referral:function(){return angular.copy(a.referral)},patient:function(){return a.patient}}});b.result.then(function(b){b.dateOfReferral=new Date(b.dateOfReferral),b.dateOfReferral.setMinutes(b.dateOfReferral.getMinutes()-b.dateOfReferral.getTimezoneOffset());var c={sourceId:b.sourceId,author:b.author,clinicalSummary:b.clinicalSummary,dateCreated:new Date(b.dateCreated),dateOfReferral:b.dateOfReferral,reason:b.reason,referralFrom:b.referralFrom,referralTo:b.referralTo,source:b.source};h.update(a.patient.id,c).then(function(){setTimeout(function(){e.go("referrals-detail",{patientId:a.patient.id,referralId:b.sourceId,page:a.currentPage})},2e3)})})}}]),angular.module("gpConnect").controller("ObservationsListCtrl",["$scope","$location","$stateParams","$sce","$modal","usSpinnerService","$state","PatientService","Observation",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.search=function(b){return-1!==angular.lowercase(b.testName).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.sampleTaken).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.dateCreated).indexOf(angular.lowercase(a.query)||"")||-1!==angular.lowercase(b.source).indexOf(angular.lowercase(a.query)||"")},c.filter&&(a.query=c.filter),i.findAllHTMLTables(c.patientId).then(function(b){var c='{"provider":"No Data","html":"No observation data available for this patient."}';a.observationTable=JSON.parse(c),a.observationTable.html=d.trustAsHtml(a.observationTable.html);var e=b.data,g=e.entry;$.each(g,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.observationTable.html=d.trustAsHtml(c.resource.section[0].text.div),a.observationTable.provider=c.resource.section[0].code.text)}),f.stop("patientSummary-spinner")}),a.go=function(b,c){g.go("observations-detail",{patientId:a.patient.id,resultIndex:b,source:c,filter:a.query,page:a.currentPage})},a.selected=function(a){return a===c.resultIndex}}]),angular.module("gpConnect").controller("ObservationsDetailCtrl",["$scope","$stateParams","$modal","$location","usSpinnerService","PatientService","Observation",function(a,b,c,d,e,f,g){Result.findDetails(b.patientId,b.resultIndex,b.source).then(function(b){a.result=b.data,e.stop("observationsDetail-spinner")})}]),angular.module("gpConnect").controller("MainSearchController",["$scope","$state","$timeout","AdvancedSearch","PatientService","ProviderRouting",function(a,b,c,d,e,f){a.mainSearchEnabled=!0,a.searchExpression="",a.errorOccurred=!1,a.openAdvancedSearch=d.openAdvancedSearch,a.cancelSearchMode=function(){a.searchExpression=""},a.searchFunction=function(b){var c=b.replace(/\s+/g,"");isNaN(c)||10!=c.length?a.setErrorOccurred(!0):e.getFhirPatient(f.defaultPractice().odsCode,c).then(function(a){g(c)})["catch"](function(){a.setErrorOccurred(!0)})},a.setErrorOccurred=function(b){c(function(){a.$apply(function(){a.errorOccurred=b},1e3)})},a.populateSearchField=function(b){c(function(){a.$apply(function(){a.searchExpression=b},1e3)})};var g=function(c){b.go("patients-summary",{patientId:c,filter:a.query})}}]),angular.module("gpConnect").controller("AdvancedSearchController",["$scope","$modalInstance","$state","modal","searchParams","AdvancedSearch",function(a,b,c,d,e,f){a.modal=d,a.searchParams=e,a.formSubmitted=!1,a.detailsFocused=!1,a.modalReopened=!1,a.searchParams.nhsNumber?a.nhsNumberFocus=!0:a.searchParams.surname?a.surnameFocus=!0:a.nhsNumberFocus=!0,a.searchParams.dateOfBirth&&(a.searchParams.dateOfBirth=new Date(a.searchParams.dateOfBirth).toISOString().slice(0,10),a.detailsFocused=!0,a.modalReopened=!0),a.cancel=function(){b.dismiss("cancel")},a.ok=function(b){b.$valid&&f.searchByDetails(a.searchParams).then(function(b){a.patients=b.data,g()})};var g=function(){a.formSubmitted=!0,b.close(),1==a.patients.length?c.go("patients-summary",{patientId:a.patients[0].nhsNumber}):a.patients.length>1?c.go("patients-list",{patientsList:a.patients,advancedSearchParams:a.searchParams}):c.go("patients-list",{patientsList:a.patients,advancedSearchParams:a.searchParams,displayEmptyTable:!0})};a.openDatePicker=function(b,c){b.preventDefault(),b.stopPropagation(),a[c]=!0},a.isNhsNumberRequired=function(b){var c=a.advancedSearchForm.nhsNumber.$viewValue;if(void 0===c&&a.areDetailsFieldsClean(b))return!0;c=c.replace(/\s+/g,"");var d=isNaN(c)||b.nhsNumber.$invalid&&0===c.length;return d&&a.areDetailsFieldsClean(b)},a.isNhsNumberTooShort=function(a){if(void 0===a)return!1;var b=a.replace(/\s+/g,"");return!isNaN(b)&&b.length>0&&b.length<10},a.isNhsNumberTooLong=function(a){if(void 0===a)return!1;var b=a.replace(/\s+/g,"");return!isNaN(b)&&b.length>10},a.isNhsNumberFieldInvalid=function(a){return a.$invalid||a.$pristine},a.areDetailsFieldsClean=function(b){var c=b.surname,d=b.forename,e=b.dateOfBirth,f=c.$invalid||!a.searchParams.surname||""==a.searchParams.surname,g=d.$invalid||!a.searchParams.forename||""==a.searchParams.forename,h=e.$invalid||!a.searchParams.dateOfBirth||""==a.searchParams.dateOfBirth;return f&&g&&h}}]),angular.module("gpConnect").controller("EncountersListCtrl",["$scope","$location","$stateParams","$modal","$state","$sce","PatientService","usSpinnerService","Encounter",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.toDateValue=moment().format("YYYY-MM-DD"),a.fromDateValue=moment().subtract(3,"years").format("YYYY-MM-DD"),a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),a.openDatePicker=function(b,c){b.preventDefault(),b.stopPropagation(),a.toDate=!1,a.fromDate=!1,a[c]=!0},a.dateChanged=function(){var b=new Date(a.toDateValue);a.toDateValue=moment(b).format("YYYY-MM-DD"),b=new Date(a.fromDateValue),a.fromDateValue=moment(b).format("YYYY-MM-DD"),j()};var j=function(){i.findAllHTMLTables(c.patientId,a.fromDateValue,a.toDateValue).then(function(b){var c='{"provider":"No Data","html":"No encounters data available for this patient."}';a.encounterTable=JSON.parse(c),a.encounterTable.html=f.trustAsHtml(a.encounterTable.html);var d=b.data,e=d.entry;$.each(e,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.encounterTable.html=f.trustAsHtml(c.resource.section[0].text.div),a.encounterTable.provider=c.resource.section[0].code.text)}),h.stop("encounterSummary-spinner")})};j()}]),angular.module("gpConnect").controller("ImmunisationsListCtrl",["$scope","$location","$stateParams","$modal","$state","$sce","PatientService","usSpinnerService","Immunisation",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),i.findAllHTMLTables(c.patientId).then(function(b){var c='{"provider":"No Data","html":"No immunisations data available for this patient."}';a.immunisationTable=JSON.parse(c),a.immunisationTable.html=f.trustAsHtml(a.immunisationTable.html);var d=b.data,e=d.entry;$.each(e,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.immunisationTable.html=f.trustAsHtml(c.resource.section[0].text.div),a.immunisationTable.provider=c.resource.section[0].code.text)}),h.stop("patientSummary-spinner")})}]),angular.module("gpConnect").controller("AdminItemsListCtrl",["$scope","$location","$stateParams","$modal","$state","$sce","PatientService","usSpinnerService","AdminItem",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),i.findAllHTMLTables(c.patientId).then(function(b){var c='{"provider":"No Data","html":"No administrative items data available for this patient."}';a.adminItemTable=JSON.parse(c),a.adminItemTable.html=f.trustAsHtml(a.adminItemTable.html);var d=b.data,e=d.entry;$.each(e,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.adminItemTable.html=f.trustAsHtml(c.resource.section[0].text.div),a.adminItemTable.provider=c.resource.section[0].code.text)}),h.stop("patientSummary-spinner")})}]),angular.module("gpConnect").controller("ClinicalItemsListCtrl",["$scope","$location","$stateParams","$modal","$state","$sce","PatientService","usSpinnerService","ClinicalItem",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),i.findAllHTMLTables(c.patientId).then(function(b){var c='{"provider":"No Data","html":"No clinical item data available for this patient."}';a.clinicalItemTable=JSON.parse(c),a.clinicalItemTable.html=f.trustAsHtml(a.clinicalItemTable.html);var d=b.data,e=d.entry;$.each(e,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.clinicalItemTable.html=f.trustAsHtml(c.resource.section[0].text.div),a.clinicalItemTable.provider=c.resource.section[0].code.text)}),h.stop("patientSummary-spinner")})}]),angular.module("gpConnect").controller("InvestigationsListCtrl",["$scope","$location","$stateParams","$modal","$state","$sce","PatientService","usSpinnerService","Investigation",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},c.page&&(a.currentPage=c.page),i.findAllHTMLTables(c.patientId).then(function(b){var c='{"provider":"No Data","html":"No investigation data available for this patient."}';a.investigationTable=JSON.parse(c),a.investigationTable.html=f.trustAsHtml(a.investigationTable.html);var d=b.data,e=d.entry;$.each(e,function(b,c){"Patient"==c.resource.resourceType,"Composition"==c.resource.resourceType&&"425173008"==c.resource.type.coding[0].code&&void 0!=c.resource.section&&(a.investigationTable.html=f.trustAsHtml(c.resource.section[0].text.div),a.investigationTable.provider=c.resource.section[0].code.text)}),h.stop("patientSummary-spinner")})}]),angular.module("gpConnect").controller("OrdersSentCtrl",["$scope","$http","$sce","$cacheFactory","$stateParams","$state","$modal","PatientService","usSpinnerService","OrderService","Organization",function(a,b,c,d,e,f,g,h,i,j,k){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},e.page&&(a.currentPage=e.page),e.filter&&(a.query=e.filter),h.getPatientFhirId(e.patientId).then(function(a){return a}).then(function(b){a.patientFhirId=b,j.findAllSentOrders(a.patientFhirId).then(function(b){a.orders=b.data;var f=d.get("orgCache");void 0==f&&(f=d("orgCache")),$.each(a.orders,function(a,b){b.detail=c.trustAsHtml(b.detail),b.sourceOrg=f.get(b.sourceOrgId),void 0==b.sourceOrg&&(b.sourceOrg=k.findOrganisation(e.patientId,b.sourceOrgId).then(function(a){b.sourceOrg=a.data.name,f.put(b.sourceOrgId,b.sourceOrg)})),b.targetOrg=f.get(b.targetOrgId),void 0==b.targetOrg&&(b.targetOrg=k.findOrganisation(e.patientId,b.targetOrgId).then(function(a){b.targetOrg=a.data.name,f.put(b.targetOrgId,b.targetOrg)}))})})["catch"](function(a){i.stop("patientSummary-spinner")})["finally"](function(){i.stop("patientSummary-spinner")})}),a.go=function(b){i.spin("patientSummary-spinner"),a.orderDetail=void 0;for(var c,d=0;d<a.orders.length;++d)if(c=a.orders[d],c.id==b){a.orderDetail=c;break}i.stop("patientSummary-spinner")},a.selected=function(a){return a===e.orderIndex},a.create=function(){g.open({templateUrl:"views/orders/sent/order-create.html",size:"md",controller:"OrderCreateModalCtrl"})}}]),angular.module("gpConnect").controller("OrderCreateModalCtrl",["$state","$stateParams","$scope","$sce","$modalInstance","usSpinnerService","OrderService","PatientService","ProviderRouting","Organization",function(a,b,c,d,e,f,g,h,i,j){c.federatedPractices=i.practices,h.getFhirPatient(i.defaultPractice().odsCode,b.patientId).then(function(a){c.patient=a,$.each(a.identifier,function(a,b){"http://fhir.nhs.net/Id/nhs-number"==b.system&&(c.patientNhsNumber=b.value)}),c.patientLocalIdentifier=a.id}),c.newOrder={},c.newOrder.fromOrg=i.defaultPractice().name,c.newOrder.toOrg=c.federatedPractices[0],c.newOrder.type="1",c.cancel=function(){e.dismiss("cancel")},c.ok=function(a){if(m(),c.formSubmitted=!0,void 0!=c.newOrder.details&&c.newOrder.details.length>0){f.spin("orderCreate-spinner");var d={};d.identifier="ID"+(new Date).getTime(),d.subjectPatientId=c.patientLocalIdentifier,d.sourceOrgId=i.defaultPractice().id,d.targetOrgId=c.newOrder.toOrg.id,"1"==c.newOrder.type?(d.reasonCode="1",d.reasonDescription="For your information"):(d.reasonCode="2",d.reasonDescription="Action needed"),d.detail=c.newOrder.details;var e=c.newOrder.toOrg.odsCode;h.getFhirPatient(e,b.patientId).then(function(a){void 0!=a?(c.recievingSysPatientLocalId=a.id,k(d)):l("<div>The recieving system does not have a local identifier for the patient with NHS Number "+b.patientId+".</div>")}),j.searchForOrganisation(e,b.patientId,e).then(function(a){void 0!=a.data.entry?(c.recievingSysRecOrgLocalId=a.data.entry[0].resource.id,k(d)):l("<div>The recieving system does not have a local identifier for it's own ODS code.</div>")},function(a){l("<div>Unable to connect to "+c.newOrder.toOrg.name+".</div>")}),j.findOrganisation(b.patientId,d.sourceOrgId).then(function(a){for(var f=0;f<a.data.identifier.length;f++)if("http://fhir.nhs.net/Id/ods-organization-code"==a.data.identifier[f].system){var g=a.data.identifier[f].value;j.searchForOrganisation(e,b.patientId,g).then(function(a){void 0!=a.data.entry?(c.recievingSysSndOrgLocalId=a.data.entry[0].resource.id,k(d)):l("<div>The recieving system does not have a local identifier for the sending system's ODS code.</div>")})}},function(a){})}else l("<div>A task description is required.</div>")};var k=function(d){if(void 0!=c.recievingSysPatientLocalId&&void 0!=c.recievingSysRecOrgLocalId&&void 0!=c.recievingSysSndOrgLocalId){var h={resourceType:"Order",identifier:[{value:d.identifier}],contained:[{resourceType:"Basic",id:"1",text:{div:"<div>"+d.detail+"</div>"},code:{coding:[{system:"http://hl7.org/fhir/basic-resource-type",code:"OrderDetails"}]}}],subject:{reference:"Patient/"+c.recievingSysPatientLocalId},source:{reference:"Organization/"+c.recievingSysSndOrgLocalId},target:{reference:"Organization/"+c.recievingSysRecOrgLocalId},reasonCodeableConcept:{coding:[{system:"http://hl7.org/fhir/ValueSet/c80-practice-codes",code:d.reasonCode,display:d.reasonDescription}]},detail:[{reference:"#1"}]};g.sendOrder(b.patientId,h,c.newOrder.toOrg.odsCode).then(function(b){d.orderDate=b.data.date,g.saveOrder(d).then(function(b){e.close(),a.reload(),f.stop("orderCreate-spinner")})})}},l=function(a){c.validationError=d.trustAsHtml(c.validationError+a),f.stop("orderCreate-spinner")},m=function(){c.validationError=""}}]),angular.module("gpConnect").controller("OrdersReceivedCtrl",["$scope","$http","$sce","$cacheFactory","$stateParams","PatientService","usSpinnerService","OrderService","Organization",function(a,b,c,d,e,f,g,h,i){a.currentPage=1,a.pageChangeHandler=function(b){a.currentPage=b},e.page&&(a.currentPage=e.page),e.filter&&(a.query=e.filter),f.getPatientFhirId(e.patientId).then(function(a){return a}).then(function(b){a.patientFhirId=b,h.findAllReceivedOrders(a.patientFhirId).then(function(b){a.orders=b.data;var f=d.get("orgCache");void 0==f&&(f=d("orgCache")),$.each(a.orders,function(a,b){b.detail=c.trustAsHtml(b.detail),b.sourceOrg=f.get(b.sourceOrgId),void 0==b.sourceOrg&&(b.sourceOrg=i.findOrganisation(e.patientId,b.sourceOrgId).then(function(a){b.sourceOrg=a.data.name,f.put(b.sourceOrgId,b.sourceOrg)})),b.targetOrg=f.get(b.targetOrgId),void 0==b.targetOrg&&(b.targetOrg=i.findOrganisation(e.patientId,b.targetOrgId).then(function(a){b.targetOrg=a.data.name,f.put(b.targetOrgId,b.targetOrg)}))})})["catch"](function(a){g.stop("patientSummary-spinner")})["finally"](function(){g.stop("patientSummary-spinner")})}),a.go=function(b){g.spin("patientSummary-spinner"),a.orderDetail=void 0;for(var c,d=0;d<a.orders.length;++d)if(c=a.orders[d],c.id==b){a.orderDetail=c;break}g.stop("patientSummary-spinner")},a.selected=function(a){return a===e.orderIndex}}]),angular.module("gpConnect").controller("InformationModalCtrl",["$scope","$modalInstance",function(a,b){a.close=function(){b.close("close")}}]);